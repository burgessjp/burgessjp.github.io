<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />









  <link rel="alternate" href="/default" title="_SOLID的个人博客">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.4.x" />



<link rel="canonical" href="http://yoursite.com/"/>


<meta property="og:type" content="website">
<meta property="og:title" content="_SOLID的个人博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="_SOLID的个人博客">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="_SOLID的个人博客">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.4.x" />







<script>
  var CONFIG = {
    search: false,
    searchPath: "/search.xml",
    fancybox: false,
    toc: true,
  }
</script>




  



    <title> _SOLID的个人博客 </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">_SOLID的个人博客</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            Home
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            Archives
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">_SOLID的个人博客</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  <section id="posts" class="posts">
    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/04/25/自动抢红包，自动安装原理之AccessibilityService/">自动抢红包，自动安装原理之AccessibilityService</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017年4月25日
        </span>
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <p><strong>*本篇文章已授权微信公众号 guolin_blog （郭霖）独家发布</strong></p>
<p>前段时间看别人博客的时候偶然间看到了<a href="http://www.jianshu.com/p/f67e950d84f7" target="_blank" rel="external">Android微信自动回复功能</a>，最后的效果也很不错，博主在文中提到了<code>AccessibilityService</code>，以前压根没接触过这东西，表示一脸懵逼。也是这个原因我去找了AccessibilityService相关的资料好好的看了一遍，发现这个东西真的太NB了，网上对AccessibilityService的应用还是有不少的文章的，但是详细的介绍资料还是比较少，对于刚刚学习这个的同学看完很多资料还是一脸茫然，于是才有了本文。我相信当你在看完本文之后，再去看前面的那篇文章，我相信会轻松很多。</p>
<hr>
<blockquote>
<p>###本文学习目录<br>1.AccessibilityService是什么<br>2.AccessibilityService的创建与配置<br>3.怎么去使用AccessibilityService<br>4.一步一步构建一个apk自动安装器</p>
</blockquote>
<p>###1.AccessibilityService是什么<br>AccessibilityService是什么，官网是这样解释的</p>
<blockquote>
<p>Accessibility services are intended to assist users with disabilities in using Android devices and apps. They run in the background and receive callbacks by the system whenAccessibilityEvents are fired.</p>
</blockquote>
<p>也就是说这是个辅助功能，目的是辅助人们去使用Android设备和应用。它在后台运行，可以接收系统的回调。</p>
<p>可见AccessibilityService的出现Google的初衷是辅助人们去使用Android设备和应用，但是当你对它足够了解了之后你会发现它的作用不仅仅只是这样。对windows编程有了解的同学肯定知道hook（钩子），AccessibilityService和windows下的hook有那么一点的相似。AccessibilityService可以拦截到系统发出的一些消息（比如窗体状态的改变，通知栏状态的改变，View被点击了等等），当拦截到这些事件我们就可以去做一些我们想做的事儿了~~~<br>AccessibilityService能做些什么呢？ 比如自动化测试、自动抢红包、自动安装等等。在带来便利的同时，也还是有需要注意的地方：当你开启了辅助功能之后会对你的隐私信息带来一些风险，所以还是需要谨慎的去开启第三方的辅助功能。当然这对于我们开发者而言都不是事，因为我们完全可以自己去开发属于我们的辅助功能。</p>
<p>###2.AccessibilityService的创建与配置</p>
<p>第一步就是自己去创建一个类继承于AccessibilityService，并实现必须实现的两个方法</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">public class MyAccessibilityService extends AccessibilityService &#123;</div><div class="line">    @Override</div><div class="line">    public void onAccessibilityEvent(AccessibilityEvent accessibilityEvent) &#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onInterrupt() &#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>随后就是在res/xml目录下新建一个xml文件（文件名随意）,后面会对这个文件作详细的介绍。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">accessibility-service</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:accessibilityEventTypes</span>=<span class="string">"typeAllMask"</span></div><div class="line">    <span class="attr">android:accessibilityFeedbackType</span>=<span class="string">"feedbackGeneric"</span>  </div><div class="line">    <span class="attr">android:canRetrieveWindowContent</span>=<span class="string">"true"</span></div><div class="line">    <span class="attr">android:description</span>=<span class="string">"@string/my_accessibility_description"</span></div><div class="line">    <span class="attr">android:notificationTimeout</span>=<span class="string">"100"</span></div><div class="line">    <span class="attr">android:packageNames</span>=<span class="string">"com.tencent.mobileqq,com.android.packageinstaller"</span> /&gt;</div></pre></td></tr></table></figure></p>
<p>最后就是去配置清单文件了<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">service</span></span></div><div class="line">           <span class="attr">android:name</span>=<span class="string">".service.MyAccessibilityService"</span></div><div class="line">           <span class="attr">android:enabled</span>=<span class="string">"true"</span></div><div class="line">           <span class="attr">android:exported</span>=<span class="string">"true"</span></div><div class="line">           <span class="attr">android:label</span>=<span class="string">"@string/app_name"</span></div><div class="line">           <span class="attr">android:permission</span>=<span class="string">"android.permission.BIND_ACCESSIBILITY_SERVICE"</span>&gt;</div><div class="line">           <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></div><div class="line">               <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.accessibilityservice.AccessibilityService"</span> /&gt;</span></div><div class="line">           <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">meta-data</span></span></div><div class="line">               <span class="attr">android:name</span>=<span class="string">"android.accessibilityservice"</span></div><div class="line">               <span class="attr">android:resource</span>=<span class="string">"@xml/my_services_config"</span> /&gt;//在meta-data里申明配置信息</div><div class="line">       <span class="tag">&lt;/<span class="name">service</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p> 别忘记了添加权限<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.BIND_ACCESSIBILITY_SERVICE"</span> /&gt;</span></div></pre></td></tr></table></figure></p>
<p>到这我们就可以把应用跑到我们的手机上了，然后打开辅助功能，去开启我们刚刚创建的这个辅助功能。如下图：<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://upload-images.jianshu.io/upload_images/623504-1f974077211e7752.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure></p>
<p>当然因为什么都没做，开启了也没什么用，下面就去看看怎么使用吧！</p>
<p>###3.怎么去使用AccessibilityService</p>
<p>先说说之前创建的那个xml文件中各个属性的含义吧</p>
<ul>
<li><code>accessibilityEventTypes </code>： 用来设置响应事件的类型，比如typeAllMask就是响应全部事件，typeNotificationStateChanged就是响应通知状态的改变，如果需要响应多种事件类型可以以 ‘ | ’ 隔开。</li>
<li><code>accessibilityFeedbackType </code>： 给用户的反馈方式，比如语音、震动等，这里用处不大。</li>
<li><code>canRetrieveWindowContent</code> ：是否可以获取活动窗体的内容，这个设置为true才可以取得窗体中的控件和事件源</li>
<li><code>description</code> ：辅助功能的描述</li>
<li><code>notificationTimeout</code> ：两个相同类型事件发送到服务的事件间隔，单位毫秒</li>
<li><code>packageNames</code> ：指定响应某个应用的事件，取值为应用的包名，多个以‘ , ’ 隔开。没有此属性则表示响应全部应用。这里我填写的是手机qq和系统安装器的包名</li>
</ul>
<p>然后进入到我们的<code>MyAccessibilityService </code>中，定位到<code>onAccessibilityEvent</code>方法编写如下代码<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">log("-------------------------------------------------------------");</div><div class="line">        int eventType = event.getEventType();//事件类型</div><div class="line">        log("packageName:" + event.getPackageName() + "");//响应事件的包名，也就是哪个应用才响应了这个事件</div><div class="line">        log("source:" + event.getSource() + "");//事件源信息</div><div class="line">        log("source class:" + event.getClassName() + "");//事件源的类名，比如android.widget.TextView</div><div class="line">        log("event type(int):" + eventType + "");</div><div class="line"></div><div class="line">        switch (eventType) &#123;</div><div class="line">            case AccessibilityEvent.TYPE_NOTIFICATION_STATE_CHANGED:// 通知栏事件</div><div class="line">                log("event type:TYPE_NOTIFICATION_STATE_CHANGED");</div><div class="line">                break;</div><div class="line">            case AccessibilityEvent.TYPE_WINDOW_STATE_CHANGED://窗体状态改变</div><div class="line">                log("event type:TYPE_WINDOW_STATE_CHANGED");</div><div class="line">                break;</div><div class="line">            case AccessibilityEvent.TYPE_VIEW_ACCESSIBILITY_FOCUSED://View获取到焦点</div><div class="line">                log("event type:TYPE_VIEW_ACCESSIBILITY_FOCUSED");</div><div class="line">                break;</div><div class="line">            case AccessibilityEvent.TYPE_GESTURE_DETECTION_START:</div><div class="line">                log("event type:TYPE_VIEW_ACCESSIBILITY_FOCUSED");</div><div class="line">                break;</div><div class="line">            case AccessibilityEvent.TYPE_GESTURE_DETECTION_END:</div><div class="line">                log("event type:TYPE_GESTURE_DETECTION_END");</div><div class="line">                break;</div><div class="line">            case AccessibilityEvent.TYPE_WINDOW_CONTENT_CHANGED:</div><div class="line">                log("event type:TYPE_WINDOW_CONTENT_CHANGED");</div><div class="line">                break;</div><div class="line">            case AccessibilityEvent.TYPE_VIEW_CLICKED:</div><div class="line">                log("event type:TYPE_VIEW_CLICKED");</div><div class="line">                break;</div><div class="line">            case AccessibilityEvent.TYPE_VIEW_TEXT_CHANGED:</div><div class="line">                log("event type:TYPE_VIEW_TEXT_CHANGED");</div><div class="line">                break;</div><div class="line">            case AccessibilityEvent.TYPE_VIEW_SCROLLED:</div><div class="line">                log("event type:TYPE_VIEW_SCROLLED");</div><div class="line">                break;</div><div class="line">            case AccessibilityEvent.TYPE_VIEW_TEXT_SELECTION_CHANGED:</div><div class="line">                log("event type:TYPE_VIEW_TEXT_SELECTION_CHANGED");</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        for (CharSequence txt : event.getText()) &#123;</div><div class="line">            log("text:" + txt);//输出当前事件包含的文本信息</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        log("-------------------------------------------------------------");</div></pre></td></tr></table></figure></p>
<p>log方法就是打印信息用的，是对Log的一个简单封装。</p>
<p>在运行一次程序，打开我们的手机qq可以看见输出日志如下</p>
<p><img src="http://upload-images.jianshu.io/upload_images/623504-b8cb8b2c0bd531e0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>可以很清晰的看见当我们打开qq或触发很多的事件，第一个响应的事件是<code>TYPE_WINDOW_STATE_CHANGED</code>,触发此事件的事件源是<code>com.tencent.mobileqq.activity.SplashActivity</code></p>
<p>接着，当我点击最上面的 ‘ 电话 ’，会得到如下日志：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://upload-images.jianshu.io/upload_images/623504-7d3c979e0283043d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<p>我就不一一截图操作的日志了，下来大家可以自行尝试。到这里你用该对<code>onAccessibilityEvent</code>有了进一步的了解。</p>
<p>###4.一步一步构建一个apk自动安装器</p>
<p>这一节来个实战的应用：做一个apk的自动安装器，点击apk文件即可开始自动安装。</p>
<p>国内的rom厂商大家都很清楚：百(sang)花(xin)齐(bing)放(kuang)，已经把原生的rom改的面目全非。所以想做一个面对全部手机的apk的自动安装器还是比较麻烦的。我的手机是魅族的，下图是魅族手机apk安装的步骤（其他手机可能会略有不同，下来自己更改不同部分即可，这里主要讲解原理）：<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://upload-images.jianshu.io/upload_images/623504-cea30f62d841e6a9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://upload-images.jianshu.io/upload_images/623504-24f650f9cde76772.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://upload-images.jianshu.io/upload_images/623504-4c27c7c62c391da6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<p>可以看见点击安装包之后会弹出一个确认框，点击继续之后会出现下一步，点击了下一步就可以点击安装了。我们要实现自动安装无非就是用程序的方式会对相关按钮的自动点击，难点就在于怎么去找到这些按钮并执行点击操作。</p>
<p>好了，下面我们可以来创建一个自动安装的服务了，步骤和第一节描述的一样将<code>packageNames</code>指定成<code>com.android.packageinstaller</code>就可以了。这里我们先别着急去实现功能（就算你想去实现，也摸不着头脑），我们还是像第二节那样去输出日志信息，<strong>查看日志输出信息（对响应事件信息的打印）是使用AccessibilityService的重点</strong>，看完日志的输出信息，然后对其分析，才会知道具体的操作。<br>我们来看看在安装apk文件时候输出的部分日志信息：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://upload-images.jianshu.io/upload_images/623504-03f81f3b844602e8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://upload-images.jianshu.io/upload_images/623504-4c107be6ffb3bcd8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://upload-images.jianshu.io/upload_images/623504-cba858987a52d3d0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<p>从日志信息中可以看出：<br>1.当我们点击了apk文件的时候，如果该文件已经存在，就会弹出一个对话框并且会响应<code>TYPE_WINDOW_STATE_CHANGE</code>事件<br>2.当我们点击了继续之后就会响应<code>TYPE_VIEW_CLICKED</code>事件，并且继续这个可以点击的View是个Button<br>3.接着点击下一步，同样也会响应<code>TYPE_VIEW_CLICKED</code>事件，并且继续这个可以点击的View是个TextView。最后就可以点击安装了（安装那步忘了截图，和第3步相应的事件是一样的）</p>
<p>经过上面几步的分析，我想你应该对后面的逻辑还是比较清楚了，直接上代码</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">public class AutoInstallService extends AccessibilityService &#123;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onAccessibilityEvent(AccessibilityEvent event) &#123;</div><div class="line">        PrintUtils.printEvent(event);</div><div class="line">        findAndPerformActionButton("继续");</div><div class="line">        findAndPerformActionTextView("下一步");</div><div class="line">        findAndPerformActionTextView("安装");</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    private void findAndPerformActionButton(String text) &#123;</div><div class="line">        if (getRootInActiveWindow() == null)//取得当前激活窗体的根节点</div><div class="line">            return;</div><div class="line">        //通过文字找到当前的节点</div><div class="line">        List&lt;AccessibilityNodeInfo&gt; nodes = getRootInActiveWindow().findAccessibilityNodeInfosByText(text);</div><div class="line">        for (int i = 0; i &lt; nodes.size(); i++) &#123;</div><div class="line">            AccessibilityNodeInfo node = nodes.get(i);</div><div class="line">            // 执行点击行为</div><div class="line">            if (node.getClassName().equals("android.widget.Button") &amp;&amp; node.isEnabled()) &#123;</div><div class="line">                node.performAction(AccessibilityNodeInfo.ACTION_CLICK);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private void findAndPerformActionTextView(String text) &#123;</div><div class="line">        if (getRootInActiveWindow() == null)</div><div class="line">            return;</div><div class="line">        //通过文字找到当前的节点</div><div class="line">        List&lt;AccessibilityNodeInfo&gt; nodes = getRootInActiveWindow().findAccessibilityNodeInfosByText(text);</div><div class="line">        for (int i = 0; i &lt; nodes.size(); i++) &#123;</div><div class="line">            AccessibilityNodeInfo node = nodes.get(i);</div><div class="line">            // 执行按钮点击行为</div><div class="line">            if (node.getClassName().equals("android.widget.TextView") &amp;&amp; node.isEnabled()) &#123;</div><div class="line">                node.performAction(AccessibilityNodeInfo.ACTION_CLICK);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>例子很简单，所以也没去对eventType做判断，当有其他需求的时候是需要对eventType做判断了，代码已经注释的比较详细，我就不再对代码作更多的讲解了，有疑问可以留言。</p>
<p>到这里你应该对AccessibilityService有了进一步的认识，会发现原来红包助手之类软件实现的原理就是利用AccessibilityService检测通知栏的状态，然后再去做一些处理。是不是有点自己去做一个红包助手的想法了？现在再去看看文章开始的那篇文章你的收获会更大：<a href="http://www.jianshu.com/p/f67e950d84f7" target="_blank" rel="external">Android微信自动回复功能</a></p>
<p>###补充说明</p>
<p>AccessibilityService中还有几个常用的方法 onServiceConnected、onInterrupt、onGesture。看名字大致也知道什么时候会被调用。</p>
<p>在onServiceConnected中可以去配置AccessibilityService的一些信息，也就是之前在xml文件可以在这里通过代码配置，不过这里没法配置canRetrieveWindowContent属性，刚开始也被这个坑了很久<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">    protected void onServiceConnected() &#123;</div><div class="line">        super.onServiceConnected();</div><div class="line">        PrintUtils.log("onServiceConnected");</div><div class="line">//        //可用代码配置当前Service的信息</div><div class="line">//        AccessibilityServiceInfo info = new AccessibilityServiceInfo();</div><div class="line">//        info.packageNames = new String[]&#123;"com.android.packageinstaller", "com.tencent.mobileqq", "com.trs.gygdapp"&#125;; //监听过滤的包名</div><div class="line">//        info.eventTypes = AccessibilityEvent.TYPES_ALL_MASK; //监听哪些行为</div><div class="line">//        info.feedbackType = AccessibilityServiceInfo.FEEDBACK_SPOKEN; //反馈</div><div class="line">//        info.notificationTimeout = 100; //通知的时间</div><div class="line">//        setServiceInfo(info);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p><a href="https://developer.android.com/reference/android/accessibilityservice/AccessibilityService.html" target="_blank" rel="external">官方文档</a></p>
<p><a href="https://github.com/burgessjp/AccessibilityServiceDemo" target="_blank" rel="external">本文源码</a></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/04/25/聊聊对RxJava与Retrofit的封装/">聊聊对RxJava与Retrofit的封装</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017年4月25日
        </span>
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <blockquote>
<p>目前RxJava和Retrofit结合使用已经是非常普遍了，网上关于这方面的文章也是层出不穷，其实大致的思想都是差不多的，今天我也来写一篇关于RxJava与Retrofit的文章，聊一聊关于RxJava与Retrofit的封装，尽可能的能让其适用于大部分项目，以供大家在学习这方面的时候多一份参考。</p>
</blockquote>
<p>关于RxJava的基础使用可以参考我的另一篇文章：<a href="http://www.jianshu.com/p/8cf84f719188" target="_blank" rel="external">是时候学习RxJava了</a>，至于Retrofit的基本使用这里我就不做介绍了，这里可以给大家提供一个学习Retrofit比较全面的网址<a href="https://futurestud.io/blog/retrofit-getting-started-and-android-client" target="_blank" rel="external">retrofit-getting-started-and-android-client</a>，对Retrofit还不太熟悉的同学可以先去看看上面的系列文章。</p>
<p>闲话不多说了，直接上今天的主题。我们先来看看关于RxJava和Retrofit最基本的使用是怎么样的</p>
<p>首先我们需要去定义一个对应接口的Service和返回结果的实体类<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public class GankResultBean &#123;</div><div class="line">    private boolean error;</div><div class="line">    private List<span class="tag">&lt;<span class="name">ResultsBean</span>&gt;</span> results;</div><div class="line">    ...省略部分代码...</div><div class="line">&#125;</div><div class="line"> public interface RxGankService &#123;</div><div class="line">        @GET("data/all/20/&#123;page&#125;")</div><div class="line">        Observable<span class="tag">&lt;<span class="name">GankResultBean</span>&gt;</span> getAndroidData(@Path("page") int page);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>接着再去初始化Retrofit<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Retrofit retrofit = new Retrofit.Builder()</div><div class="line">                .baseUrl("http://gank.io/api/")</div><div class="line">                .addConverterFactory(GsonConverterFactory.create())</div><div class="line">                .addCallAdapterFactory(RxJavaCallAdapterFactory.create())</div><div class="line">                .build();</div></pre></td></tr></table></figure></p>
<p>最后我们就可以去使用了<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">RxGankService rxGankService = retrofit.create(RxGankService.class);</div><div class="line">Observable<span class="tag">&lt;<span class="name">GankResultBean</span>&gt;</span> observable = rxGankService.getAndroidData(1);</div><div class="line">observable.subscribeOn(Schedulers.io())</div><div class="line">               .observeOn(AndroidSchedulers.mainThread())</div><div class="line">               .subscribe(new Subscriber<span class="tag">&lt;<span class="name">GankResultBean</span>&gt;</span>() &#123;</div><div class="line">                   @Override</div><div class="line">                   public void onCompleted() &#123;</div><div class="line"></div><div class="line">                   &#125;</div><div class="line"></div><div class="line">                   @Override</div><div class="line">                   public void onError(Throwable e) &#123;</div><div class="line"></div><div class="line">                   &#125;</div><div class="line"></div><div class="line">                   @Override</div><div class="line">                   public void onNext(GankResultBean gankResultBean) &#123;</div><div class="line"></div><div class="line">                   &#125;</div><div class="line">               &#125;);</div></pre></td></tr></table></figure></p>
<p>逻辑还是挺清晰的，但是呢，如果每次使用都让你去写这么多的代码肯定会觉得很乏味，并且这里我还没有对返回结果做错误处理，于是我们就应该考虑一下对代码封装一下了。</p>
<p>但是应该从哪里入手呢，这里简单分析下：</p>
<ul>
<li>看上面的代码我们会发现Retrofit初始化的那段代码，一般就一个baseUrl会有不同，其他的基本是一致的，如果我们每次去创建一个Service都要去写那么多重复的代码也大大增加了冗余度</li>
<li>对于返回的结果一般情况下数据格式是这样的：<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">   code:1,</div><div class="line">   msg:"your message",</div><div class="line">   data:[]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>code是服务器端和客户端约定好的一种规则，比如1表示数据请求成功，-1表示请求失败，-2表示权限不足等等，msg代表提示消息，其中data可能是数组对象也可能是普通的对象，我们可以考虑对返回的结果做一个统一的处理。</p>
<p>经过上面的分析我们大致有了一个方向，对于Service的创建应该有一个类去单独处理。所以这里我创建了一个ServiceFactory的类。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Created by _SOLID</div><div class="line"> * Date:2016/7/27</div><div class="line"> * Time:15:23</div><div class="line"> */</div><div class="line">public class ServiceFactory &#123;</div><div class="line"></div><div class="line">    private final Gson mGsonDateFormat;</div><div class="line"></div><div class="line">    private ServiceFactory() &#123;</div><div class="line">        mGsonDateFormat = new GsonBuilder()</div><div class="line">                .setDateFormat("yyyy-MM-dd hh:mm:ss")</div><div class="line">                .create();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static class SingletonHolder &#123;</div><div class="line">        private static final ServiceFactory INSTANCE = new ServiceFactory();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static ServiceFactory getInstance() &#123;</div><div class="line">        return SingletonHolder.INSTANCE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * create a service</div><div class="line">     *</div><div class="line">     * @param serviceClass</div><div class="line">     * @param <span class="tag">&lt;<span class="name">S</span>&gt;</span></div><div class="line">     * @return</div><div class="line">     */</div><div class="line">    public <span class="tag">&lt;<span class="name">S</span>&gt;</span> S createService(Class<span class="tag">&lt;<span class="name">S</span>&gt;</span> serviceClass) &#123;</div><div class="line">        String baseUrl = "";</div><div class="line">        try &#123;</div><div class="line">            Field field1 = serviceClass.getField("BASE_URL");</div><div class="line">            baseUrl = (String) field1.get(serviceClass);</div><div class="line">        &#125; catch (NoSuchFieldException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; catch (IllegalAccessException e) &#123;</div><div class="line">            e.getMessage();</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        Retrofit retrofit = new Retrofit.Builder()</div><div class="line">                .baseUrl(baseUrl)</div><div class="line">                .client(getOkHttpClient())</div><div class="line">                .addConverterFactory(GsonConverterFactory.create(mGsonDateFormat))</div><div class="line">                .addCallAdapterFactory(RxJavaCallAdapterFactory.create())</div><div class="line">                .build();</div><div class="line">        return retrofit.create(serviceClass);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private final static long DEFAULT_TIMEOUT = 10;</div><div class="line"></div><div class="line">    private OkHttpClient getOkHttpClient() &#123;</div><div class="line">        //定制OkHttp</div><div class="line">        OkHttpClient.Builder httpClientBuilder = new OkHttpClient.Builder();</div><div class="line">        //设置超时时间</div><div class="line">        httpClientBuilder.connectTimeout(DEFAULT_TIMEOUT, TimeUnit.SECONDS);</div><div class="line">        httpClientBuilder.writeTimeout(DEFAULT_TIMEOUT, TimeUnit.SECONDS);</div><div class="line">        httpClientBuilder.readTimeout(DEFAULT_TIMEOUT, TimeUnit.SECONDS);</div><div class="line">        //设置缓存</div><div class="line">        File httpCacheDirectory = new File(FileUtils.getCacheDir(SolidApplication.getInstance()), "OkHttpCache");</div><div class="line">        httpClientBuilder.cache(new Cache(httpCacheDirectory, 10 * 1024 * 1024));</div><div class="line">        return httpClientBuilder.build();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其他的代码我就不做说明了，这里我只对createService方法做一个简单的说明：对于baseUrl是用反射去获取我们自定义Service中的BASE_URL字段，所以在使用的时候就有了一个约定，当我们新建一个Service的时候一定要有BASE_URL字段并赋值。也就是说我们在新建的Service大致是这样的<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public interface GankService &#123;</div><div class="line"></div><div class="line">    String BASE_URL = "http://www.gank.io/api/";</div><div class="line"></div><div class="line">   @GET("data/all/20/&#123;page&#125;") Observable<span class="tag">&lt;<span class="name">GankResultBean</span>&gt;</span> getAndroidData(@Path("page") int page);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>现在我们应该怎样去使用呢<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GankService gankService = ServiceFactory.getInstance().createService(GankService.class);</div></pre></td></tr></table></figure></p>
<p>是不是一下感觉创建一个Service的代码一下简洁了很多。这里还没完，我们只是解决了Service的创建，还没有对结果去做处理。</p>
<p>我以 <em><a href="http://gank.io/api/data/Android/10/1" target="_blank" rel="external">http://gank.io/api/data/Android/10/1</a></em> 这个接口为例：<br>他返回的结果的格式是这样的：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  "error": false, </div><div class="line">  "results": []</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以这里我定义了这样的一个泛型类（T 是返回结果results的类型）<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public class HttpResult<span class="tag">&lt;<span class="name">T</span>&gt;</span> &#123;</div><div class="line">    public boolean error;</div><div class="line">    public T results;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在处理结果的时候，其实用户只关心的是T，对其他数据可以统一处理下就比如这里的error字段，有了这个我们就可以再封装一下Subscriber了。<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">public abstract class HttpResultSubscriber&lt;T&gt; extends Subscriber&lt;HttpResult&lt;T&gt;&gt; &#123;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onCompleted() &#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onError(Throwable e) &#123;</div><div class="line">        Logger.e(this,e.getMessage());</div><div class="line">        e.printStackTrace();</div><div class="line">        //在这里做全局的错误处理</div><div class="line">        if (e instanceof HttpException) &#123;</div><div class="line">            // ToastUtils.getInstance().showToast(e.getMessage());</div><div class="line">        &#125;</div><div class="line">        _onError(e);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onNext(HttpResult&lt;T&gt; t) &#123;</div><div class="line">        if (!t.error)</div><div class="line">            onSuccess(t.results);</div><div class="line">        else</div><div class="line">            _onError(new Throwable("error=" + t.error));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public abstract void onSuccess(T t);</div><div class="line"></div><div class="line">    public abstract void _onError(Throwable e);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们来看看现在怎么使用吧：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">ServiceFactory.getInstance()</div><div class="line">                .createService(GankService.class)</div><div class="line">                .getAndroidData(1)</div><div class="line">                .observeOn(AndroidSchedulers.mainThread())</div><div class="line">                .subscribeOn(Schedulers.io())</div><div class="line">                .subscribe(new HttpResultSubscriber&lt;List&lt;GanHuoDataBean&gt;&gt;() &#123;</div><div class="line">                    @Override</div><div class="line">                    public void onSuccess(List&lt;GanHuoDataBean&gt; list) &#123;</div><div class="line"></div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    @Override</div><div class="line">                    public void _onError(Throwable e) &#123;</div><div class="line"></div><div class="line">                    &#125;</div><div class="line">                &#125;);</div></pre></td></tr></table></figure></p>
<p>把这段代码与文章开始那段代码比较一下，是不是神清气爽了很多，并且这里还做了错误处理的。</p>
<p>细心的同学肯定注意到了这段代码，这段代码每次都是在重复的使用<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">observeOn(AndroidSchedulers.mainThread())</div><div class="line">.subscribeOn(Schedulers.io())</div></pre></td></tr></table></figure></p>
<p>这里我们可以创建一个TransformUtils类去处理一下<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">public class TransformUtils &#123;</div><div class="line"></div><div class="line">    public static <span class="tag">&lt;<span class="name">T</span>&gt;</span> Observable.Transformer<span class="tag">&lt;<span class="name">T,</span> <span class="attr">T</span>&gt;</span> defaultSchedulers() &#123;</div><div class="line">        return new Observable.Transformer<span class="tag">&lt;<span class="name">T,</span> <span class="attr">T</span>&gt;</span>() &#123;</div><div class="line">            @Override</div><div class="line">            public Observable<span class="tag">&lt;<span class="name">T</span>&gt;</span> call(Observable<span class="tag">&lt;<span class="name">T</span>&gt;</span> tObservable) &#123;</div><div class="line">                return tObservable.observeOn(AndroidSchedulers.mainThread()).subscribeOn(Schedulers.io());</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static <span class="tag">&lt;<span class="name">T</span>&gt;</span> Observable.Transformer<span class="tag">&lt;<span class="name">T,</span> <span class="attr">T</span>&gt;</span> all_io() &#123;</div><div class="line">        return new Observable.Transformer<span class="tag">&lt;<span class="name">T,</span> <span class="attr">T</span>&gt;</span>() &#123;</div><div class="line">            @Override</div><div class="line">            public Observable<span class="tag">&lt;<span class="name">T</span>&gt;</span> call(Observable<span class="tag">&lt;<span class="name">T</span>&gt;</span> tObservable) &#123;</div><div class="line">                return tObservable.observeOn(Schedulers.io()).subscribeOn(Schedulers.io());</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后在使用的时候使用compose操作符就可以了<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">.compose(TransformUtils.&lt;HttpResult&lt;List&lt;GanHuoDataBean&gt;&gt;&gt;defaultSchedulers())</div></pre></td></tr></table></figure></p>
<p>我们都知道对于网络请求肯定会有不成功的情况，有没有一种方案能够处理一下？其实RxJava已经为我们提供了这样的一个操作符<code>RetryWhen</code>可以用来实现重试机制，我这里有一个实现好的一个机制，默认情况下，最多重试3次，第一次会等3s，第二次会等6s，第三次会等9s。<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">public class RetryWhenNetworkException implements Func1&lt;Observable&lt;? extends Throwable&gt;, Observable&lt;?&gt;&gt; &#123;</div><div class="line">    private int count = 3;//retry count</div><div class="line">    private long delay = 3000;//delay time</div><div class="line"></div><div class="line">    public RetryWhenNetworkException() &#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public RetryWhenNetworkException(int count) &#123;</div><div class="line">        this.count = count;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public RetryWhenNetworkException(int count, long delay) &#123;</div><div class="line">        this.count = count;</div><div class="line">        this.delay = delay;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public Observable&lt;?&gt; call(Observable&lt;? extends Throwable&gt; observable) &#123;</div><div class="line">        return observable</div><div class="line">                .zipWith(Observable.range(1, count + 1), new Func2&lt;Throwable, Integer, Wrapper&gt;() &#123;</div><div class="line">                    @Override</div><div class="line">                    public Wrapper call(Throwable throwable, Integer integer) &#123;</div><div class="line">                        return new Wrapper(throwable, integer);</div><div class="line">                    &#125;</div><div class="line">                &#125;).flatMap(new Func1&lt;Wrapper, Observable&lt;?&gt;&gt;() &#123;</div><div class="line">                    @Override</div><div class="line">                    public Observable&lt;?&gt; call(Wrapper wrapper) &#123;</div><div class="line">                        if ((wrapper.throwable instanceof ConnectException</div><div class="line">                                || wrapper.throwable instanceof SocketTimeoutException</div><div class="line">                                || wrapper.throwable instanceof TimeoutException)</div><div class="line">                                &amp;&amp; wrapper.index &lt; count + 1) &#123;</div><div class="line">                            return Observable.timer(delay + (wrapper.index - 1) * delay, TimeUnit.MILLISECONDS);</div><div class="line">                        &#125;</div><div class="line">                        return Observable.error(wrapper.throwable);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private class Wrapper &#123;</div><div class="line">        private int index;</div><div class="line">        private Throwable throwable;</div><div class="line"></div><div class="line">        public Wrapper(Throwable throwable, int index) &#123;</div><div class="line">            this.index = index;</div><div class="line">            this.throwable = throwable;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<p>到这里对于RxJava与Retrofit的封装的基本封装就差不多了，也能适用于大部分的项目中去了，一般情况下改改HttpResult和HttpResultSubscriber这两个类就可以了。<br>但是实际开发中有可能会遇到这样的一种情况：直接去访问一个完整的Url，还有用Retrofit去做下载该怎么做呢？</p>
<p>其实解决方案是有的，这里我们可以去定义一个CommonService<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">public interface CommonService &#123;</div><div class="line">    String BASE_URL = "http://www.example.com/";//这个不重要，可以随便写，但是必须有</div><div class="line"></div><div class="line">    @GET</div><div class="line">    Observable<span class="tag">&lt;<span class="name">ResponseBody</span>&gt;</span> loadString(@Url String url);</div><div class="line"></div><div class="line">    @GET</div><div class="line">    @Streaming</div><div class="line">    Observable<span class="tag">&lt;<span class="name">ResponseBody</span>&gt;</span> download(@Url String url);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其实就是把参数的注解换成@Url就可以了，关于实现的细节可以参考文末给出的源码。</p>
<p>本文源码地址:<a href="https://github.com/burgessjp/GanHuoIO/tree/v3.1.0/library/src/main/java/ren/solid/library/rx/retrofit" target="_blank" rel="external">源码</a></p>
<p>参考资料可以去我管理的专题查看：<br><a href="http://www.jianshu.com/collection/d79a6385bded" target="_blank" rel="external">RxJava系列专题（Android方向）</a></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/04/25/比系统自带的更好用的SnackBar/">比系统自带的更好用的SnackBar</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017年4月25日
        </span>
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <p>关于SnackBar我相信不用我多说，我相信大部分的同学肯定都知道。他是在Android5.0之后才推出的，可以为一个操作提供了一个轻量级的反馈，用来代替Toast的。如果有不太了解的同学或者还不太清楚可以直接定位到 <a href="http://www.jianshu.com/p/1e6eed09d48b" target="_blank" rel="external">这篇文章</a> 的Snackbar去看看。</p>
<p>对于SnackBar我们通常是这样使用的，<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Snackbar.make(mDrawerLayout,"再按一次退出",Snackbar.LENGTH_SHORT).show();</div></pre></td></tr></table></figure></p>
<p>他的展示效果比较单一，就只有一个黑色的背景。我们能不能每一种类型的提示都有不同的样式呢，答案是:肯定可以。<br>下面我就来简单介绍下今天要介绍的这个关于SnackBar的扩展，其实这个扩展我也参考了一些博客，发现一些博客只提供了方法，没有具体的去封装，还有一些的确封装了，但是个人感觉提供的Api不太好用，于是决定自己再去做一下。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://upload-images.jianshu.io/upload_images/623504-64c26a8d8fa7bfab.gif?imageMogr2/auto-orient/strip" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<p>来看看最后的效果图。</p>
<p>关于这个扩展的使用，和原始api基本一致，但比原生的更好用。<br>先来看看怎么使用。</p>
<ul>
<li><p>不带Action的</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">SnackBarUtils.makeShort(v, "TEXT").show();</div><div class="line">SnackBarUtils.makeShort(v, "TEXT").danger();</div><div class="line">SnackBarUtils.makeShort(v, "TEXT").confirm();</div><div class="line">SnackBarUtils.makeShort(v, "TEXT").info();</div><div class="line">SnackBarUtils.makeShort(v, "TEXT").warning();</div></pre></td></tr></table></figure>
</li>
<li><p>带有Action的</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">SnackBarUtils.makeShort(v, "TEXT").info("action", new View.OnClickListener() &#123;</div><div class="line">                   @Override</div><div class="line">                   public void onClick(View v) &#123;</div><div class="line">                       SnackBarUtils.makeShort(v, "TEXT").show();</div><div class="line">                   &#125;</div><div class="line">               &#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>是不是很简洁，也很方便！ 如果你想让Snackbar显示的时间稍微长一点，可以调用<code>SnackBarUtils.makeLong()</code>方法，使用方法与上面一样。</p>
<p>其实代码的实现很简单，全部代码也没没到100行。（ps：在做这个封装的时候，我刚开始想过用构造者模式，最后在实现的时候发现不仅api使用不方便，还有点杀鸡用宰牛刀的感觉）。好了下面来看看代码实现。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Created by _SOLID</div><div class="line"> * Date:2016/5/9</div><div class="line"> * Time:11:30</div><div class="line"> */</div><div class="line">public class SnackBarUtils &#123;</div><div class="line">    private static final int color_danger = 0xffa94442;</div><div class="line">    private static final int color_success = 0xff3c763d;</div><div class="line">    private static final int color_info = 0xff31708f;</div><div class="line">    private static final int color_warning = 0xff8a6d3b;</div><div class="line"></div><div class="line">    private static final int action_color = 0xffCDC5BF;</div><div class="line"></div><div class="line">    private Snackbar mSnackbar;</div><div class="line"></div><div class="line">    private SnackBarUtils(Snackbar snackbar) &#123;</div><div class="line">        mSnackbar = snackbar;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static SnackBarUtils makeShort(View view, String text) &#123;</div><div class="line">        Snackbar snackbar = Snackbar.make(view, text, Snackbar.LENGTH_SHORT);</div><div class="line">        return new SnackBarUtils(snackbar);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static SnackBarUtils makeLong(View view, String text) &#123;</div><div class="line">        Snackbar snackbar = Snackbar.make(view, text, Snackbar.LENGTH_LONG);</div><div class="line">        return new SnackBarUtils(snackbar);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private View getSnackBarLayout(Snackbar snackbar) &#123;</div><div class="line">        if (snackbar != null) &#123;</div><div class="line">            return snackbar.getView();</div><div class="line">        &#125;</div><div class="line">        return null;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    private Snackbar setSnackBarBackColor(int colorId) &#123;</div><div class="line">        View snackBarView = getSnackBarLayout(mSnackbar);</div><div class="line">        if (snackBarView != null) &#123;</div><div class="line">            snackBarView.setBackgroundColor(colorId);</div><div class="line">        &#125;</div><div class="line">        return mSnackbar;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void info() &#123;</div><div class="line">        setSnackBarBackColor(color_info);</div><div class="line">        show();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void info(String actionText, View.OnClickListener listener) &#123;</div><div class="line">        setSnackBarBackColor(color_info);</div><div class="line">        show(actionText, listener);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void warning() &#123;</div><div class="line">        setSnackBarBackColor(color_warning);</div><div class="line">        show();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void warning(String actionText, View.OnClickListener listener) &#123;</div><div class="line">        setSnackBarBackColor(color_warning);</div><div class="line">        show(actionText, listener);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void danger() &#123;</div><div class="line">        setSnackBarBackColor(color_danger);</div><div class="line">        show();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void danger(String actionText, View.OnClickListener listener) &#123;</div><div class="line">        setSnackBarBackColor(color_danger);</div><div class="line">        show(actionText, listener);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void confirm() &#123;</div><div class="line">        setSnackBarBackColor(color_success);</div><div class="line">        show();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void confirm(String actionText, View.OnClickListener listener) &#123;</div><div class="line">        setSnackBarBackColor(color_success);</div><div class="line">        show(actionText, listener);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void show() &#123;</div><div class="line">        mSnackbar.show();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void show(String actionText, View.OnClickListener listener) &#123;</div><div class="line">        mSnackbar.setActionTextColor(action_color);</div><div class="line">        mSnackbar.setAction(actionText, listener).show();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果感觉好用可直接拿走。因为相对而言比较简单，所以代码里面就没给注释了。我相信正在阅读的你肯定能看懂，真看不懂的可留言。如果感觉字体颜色不太搭，可以修改代码为每一种样式提供一种字体颜色，或者如果感觉api不够用，还可以为这个扩展类带来更多的灵活的api。</p>
<p>参考文章：</p>
<ul>
<li><a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2015/0714/3186.html" target="_blank" rel="external">Design Support Library第三部分：Snackbar样式</a></li>
<li><a href="http://mp.weixin.qq.com/s?__biz=MzAxMTI4MTkwNQ==&amp;mid=2650820083&amp;idx=1&amp;sn=1cd6b3d66b9d0054054df548c5b4afbb&amp;scene=23&amp;srcid=05090VutW25mPtOHU6HqozkR#rd" target="_blank" rel="external">没时间解释了，快使用SnackBar! </a></li>
</ul>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/04/25/是时候学习RxJava了/">是时候学习RxJava了</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017年4月25日
        </span>
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://upload-images.jianshu.io/upload_images/623504-95ab3050919a97ab.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="RxJava" title="">
                </div>
                <div class="image-caption">RxJava</div>
            </figure>
<p>从开始最开始学习RxJava到现在也有一段时间了，还记得去年第一次看RxJava的文章就是<a href="https://github.com/rengwuxian" target="_blank" rel="external">扔物线</a>的的这篇文章<a href="http://gank.io/post/560e15be2dca930e00da1083#toc_1" target="_blank" rel="external">给 Android 开发者的 RxJava 详解</a>，那一次我看了整整一个下午，由于在那之前我完全没接触过RxJava，也不知道那是个什么，看完很多地方都还不是很理解，整个人都是晕晕的，当然收获也还是有的，至少对RxJava有了一个初步的概念。那次之后我就没再去碰过RxJava了，当时心里想的是，如果后面需要这方面的东西我再来学习也不迟。<br>时间差不多过了半年，RxJava也越来越火了，使用RxJava的开发者也是越来越多，github上关于的开源库中使用RxJava的也越来越多。当我再去看一些开源库的时候，由于很多地方都用到了RxJava，就发现很多代码都看不懂了，这也就激起了再次去学习RxJava的动力，随后就在网上各种的查找RxJava相关的学习资料，从头学习，我又去看了一遍<a href="http://gank.io/post/560e15be2dca930e00da1083#toc_1" target="_blank" rel="external">给 Android 开发者的 RxJava 详解</a>，收获还是很多的，本文也是对这段时间我学习RxJava的一个小结，以下知识点主要针对于Android开发者。</p>
<blockquote>
<h3 id="本文的学习目录"><a href="#本文的学习目录" class="headerlink" title="本文的学习目录"></a>本文的学习目录</h3><hr>
<p>1.RxJava是什么<br>2.在Android中怎么去使用RxJava<br>3.RxJava操作符的介绍<br>4.RxJava在生产环境中的使用<br>5.RxJava学习的参考资料</p>
</blockquote>
<h2 id="1-RxJava是什么"><a href="#1-RxJava是什么" class="headerlink" title="1.RxJava是什么"></a>1.RxJava是什么</h2><p>要知道RxJava是什么，那么你应该先去了解一下Rx。Rx的全称是Reactive Extensions，直译过来就是响应式扩展。Rx基于观察者模式，他是一种编程模型，目标是提供一致的编程接口，帮助开发者更方便的处理异步数据流。<em>ReactiveX.io给的定义是，Rx是一个使用可观察数据流进行异步编程的编程接口，ReactiveX结合了观察者模式、迭代器模式和函数式编程的精华。</em>Rx已经渗透到了各个语言中，有了Rx所以才有了 RxJava，Rx.NET、RxJS、RxSwift、Rx.rb、RxPHP等等，更详细的可以去这里看看<a href="http://reactivex.io/languages.html" target="_blank" rel="external">languages</a></p>
<p>那么RxJava到底是什么，我对于他的理解就针对于Java语言的一个异步的响应式编程库。</p>
<h2 id="2-怎么去使用RxJava"><a href="#2-怎么去使用RxJava" class="headerlink" title="2.怎么去使用RxJava"></a>2.怎么去使用RxJava</h2><p>在gradle文件的dependencies中加入以下代码即可（以下版本可能不是最新的，需要最新的可到<a href="https://github.com/ReactiveX/RxAndroid" target="_blank" rel="external">RxAndroid</a>查看）<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">compile 'io.reactivex:rxandroid:1.2.0'</div><div class="line">compile 'io.reactivex:rxjava:1.1.5'</div></pre></td></tr></table></figure></p>
<h2 id="3-RxJava操作符的介绍"><a href="#3-RxJava操作符的介绍" class="headerlink" title="3.RxJava操作符的介绍"></a>3.RxJava操作符的介绍</h2><p>有了以上的配置，我们就可以在Android中使用RxJava了。对于RxJava的使用，最重要的还是对于操作符的学习，熟悉了操作符才能更好的使用RxJava。RxJava中的操作符是非常丰富的，关于RxJava操作符介绍的文章已经是属于一搜就是一大堆的那种了，所以本文就不多做介绍了，在这里给大家推荐一个学习操作符比较好的地方<a href="https://mcxiaoke.gitbooks.io/rxdocs/content/Operators.html" target="_blank" rel="external">Operaters</a></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://upload-images.jianshu.io/upload_images/623504-c57385da15b90d9a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<h2 id="4-RxJava在生产环境中的使用"><a href="#4-RxJava在生产环境中的使用" class="headerlink" title="4.RxJava在生产环境中的使用"></a>4.RxJava在生产环境中的使用</h2><p>想必学习RxJava的同学，在学习完操作符之后，最想知道的是怎么将其用在我们平时的开发当中去，本节就带大家去了解一下怎么去应用RxJava。</p>
<blockquote>
<p>RxBinding<br>节流(防止按钮的重复点击)<br>轮询，定时操作<br>RxPermissions<br>RxBus<br>RxJava与Retrofit<br>等待你们的补充~~~</p>
</blockquote>
<p><strong>(1) RxBinding</strong></p>
<p><a href="https://github.com/JakeWharton/RxBinding" target="_blank" rel="external">RxBinding</a>是<a href="https://github.com/JakeWharton" target="_blank" rel="external">JakeWharton</a>大牛用RxJava为Android控件编写的一个控件绑定库，并且为各个包下的控件都编写相应的库，如下所示<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">Platform bindings:</div><div class="line">compile 'com.jakewharton.rxbinding:rxbinding:0.4.0'</div><div class="line"></div><div class="line">'support-v4' library bindings:</div><div class="line">compile 'com.jakewharton.rxbinding:rxbinding-support-v4:0.4.0'</div><div class="line"></div><div class="line">'appcompat-v7' library bindings:</div><div class="line">compile 'com.jakewharton.rxbinding:rxbinding-appcompat-v7:0.4.0'</div><div class="line"></div><div class="line">'design' library bindings:</div><div class="line">compile 'com.jakewharton.rxbinding:rxbinding-design:0.4.0'</div><div class="line"></div><div class="line">'recyclerview-v7' library bindings:</div><div class="line">compile 'com.jakewharton.rxbinding:rxbinding-recyclerview-v7:0.4.0'</div><div class="line"></div><div class="line">'leanback-v17' library bindings:</div><div class="line">compile 'com.jakewharton.rxbinding:rxbinding-leanback-v17:0.4.0'</div></pre></td></tr></table></figure></p>
<p>我们只需引入对应地库就可以使用了。</p>
<p>比如我们对Button添加一个单击事件就可以这样做了<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Button button = (Button) findViewById(R.id.button);</div><div class="line"></div><div class="line">      RxView.clicks(button).subscribe(new Action1<span class="tag">&lt;<span class="name">Void</span>&gt;</span>() &#123;</div><div class="line">          @Override</div><div class="line">          public void call(Void aVoid) &#123;</div><div class="line">            Log.i("test", "clicked");</div><div class="line">          &#125;</div><div class="line">      &#125;);</div></pre></td></tr></table></figure></p>
<p>到这里，你肯定会说，这并没有没什么卵用，还不如直接设置一个setOnClickListener来的方便，直接。继续往下看</p>
<p>通常情况下，如果我们要防止一个按钮重复点击会怎么做？设置一个第一次按下的时间，然后在第二次点击的时候去判断？NO NO NO，这样做都太low了，我们来看看用RxBing怎样去实现</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">RxView.clicks(button).debounce(300, TimeUnit.MILLISECONDS).subscribe(new Action1<span class="tag">&lt;<span class="name">Void</span>&gt;</span>() &#123;</div><div class="line">            @Override</div><div class="line">            public void call(Void aVoid) &#123;</div><div class="line">                Log.i("test", "clicked");</div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<p>很爽吧，这里过滤掉了在300ms内的重复点击，只需加一个操作符就可以了，而不用我们去编写一大堆并且还容易出错的逻辑代码了。</p>
<p>这里使用最多的一个地方就是在我们做搜索的时候，再结合filter操作，去过滤掉那些没必要的查询操作，来减小服务器的压力和客户端的流量输出。</p>
<p><strong>(2) 轮询，定时操作</strong><br>在做App的时候，有些地方我们可能会时不时的去请求服务器，以至于客户端的数据是最新的，在RxJava中可以这样做<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">//每隔两秒执行一次</div><div class="line">Observable.interval(2, 2, TimeUnit.SECONDS).subscribe(new Action1<span class="tag">&lt;<span class="name">Long</span>&gt;</span>() &#123;</div><div class="line">         @Override</div><div class="line">         public void call(Long aLong) &#123;</div><div class="line">             //TODO WHAT YOU WANT</div><div class="line">         &#125;</div><div class="line">     &#125;);</div></pre></td></tr></table></figure></p>
<p>在两秒后去执行一些操作（比如启动页跳转到主页面）<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Observable.timer(2, TimeUnit.SECONDS).subscribe(new Action1<span class="tag">&lt;<span class="name">Long</span>&gt;</span>() &#123;</div><div class="line">           @Override</div><div class="line">           public void call(Long aLong) &#123;</div><div class="line">               //TODO WHAT YOU WANT</div><div class="line">           &#125;</div><div class="line">       &#125;);</div></pre></td></tr></table></figure></p>
<p><strong>(3) RxPermissions</strong><br><a href="https://github.com/tbruyelle/RxPermissions" target="_blank" rel="external">RxPermissions</a>也是国外的大牛开发的基于RxJava的Android权限管理库，他让6.0以上的权限管理更加的简单，如果有适配6.0以上的手机的需求，这个库是个不错的选择。下面我们来看看基本的用法。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">// 请求相机权限</div><div class="line"> RxPermissions.getInstance(this)</div><div class="line"> .request(Manifest.permission.CAMERA)</div><div class="line"> .subscribe(granted -&gt; &#123;</div><div class="line">     if (granted) &#123; // 用户同意了（在6.0之前的手机始终都为true）</div><div class="line">       //可以拍照了</div><div class="line">     &#125; else &#123;</div><div class="line">        //可以在这里提示用户，或者再次请求</div><div class="line">     &#125;</div><div class="line"> &#125;);</div></pre></td></tr></table></figure>
<p>当然，如果我想一次请求多个权限呢，每次都去写上面的代码肯定是个不好的做法，RxPermissions的作者也考虑到了这一点，在Api里提供了一个多参数的重载<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">//取得相机权限和读取手机状态</div><div class="line">RxPermissions.getInstance(this)</div><div class="line">    .request(Manifest.permission.CAMERA,</div><div class="line">             Manifest.permission.READ_PHONE_STATE)</div><div class="line">    .subscribe(granted -&gt; &#123;</div><div class="line">        if (granted) &#123;</div><div class="line">          </div><div class="line">        &#125; else &#123;</div><div class="line">           </div><div class="line">        &#125;</div><div class="line">    &#125;);</div></pre></td></tr></table></figure></p>
<p>更多的资料还请去github上去查看。<br><strong>(4) RxBus</strong><br>有了RxJava，EventBus、Otto什么的都可以靠边了，因为RxJava本身就自带了这个功能，我们只需做一下简单的封装就可以使用了，也顺便减少了我们项目的体积。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">public class RxBus &#123;</div><div class="line"></div><div class="line">    private final Subject<span class="tag">&lt;<span class="name">Object,</span> <span class="attr">Object</span>&gt;</span> _bus;</div><div class="line"></div><div class="line">    private static class RxBusHolder &#123;</div><div class="line">        private static final RxBus instance = new RxBus();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private RxBus() &#123;</div><div class="line">        _bus = new SerializedSubject<span class="tag">&lt;&gt;</span>(PublishSubject.create());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static synchronized RxBus getInstance() &#123;</div><div class="line">        return RxBusHolder.instance;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void post(Object o) &#123;</div><div class="line">        _bus.onNext(o);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public <span class="tag">&lt;<span class="name">T</span>&gt;</span> Observable<span class="tag">&lt;<span class="name">T</span>&gt;</span> toObserverable(Class<span class="tag">&lt;<span class="name">T</span>&gt;</span> eventType) &#123;</div><div class="line">        return _bus.ofType(eventType);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>怎么去使用？<br>在需要发送消息的地方<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">RxBus.getInstance().post("SomeChange");</div></pre></td></tr></table></figure></p>
<p>在需要接收消息的地方<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"> Subscription mSubscription = RxBus.getInstance().toObserverable(String.class).subscribe(new Action1<span class="tag">&lt;<span class="name">String</span>&gt;</span>() &#123;</div><div class="line">            @Override</div><div class="line">            public void call(String s) &#123;</div><div class="line">                handleRxMsg(s);</div><div class="line">            &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>不要忘了在适当的地方去取消这个订阅（以免发生内存泄漏）<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mSubscription.unsubscribe();</div></pre></td></tr></table></figure></p>
<p>到这里可能你有个疑问，Subject是个什么鬼！<br>其实Subject同时充当了Observer和Observable的角色，他可以发射数据也可以接收数据，有AsyncSubject、BehaviorSubject、PublishSubject、ReplaySubject四种，详细的介绍请看<a href="https://mcxiaoke.gitbooks.io/rxdocs/content/Subject.html" target="_blank" rel="external">Subject</a></p>
<p><strong>(5) RxJava与Retrofit</strong></p>
<p>Retrofit可能大家都不太陌生了，如果你还不知道的话，那么赶紧去学习吧，这么强大的框架怎么能不知道呢！</p>
<p>后面的讲解是基于了解过Retrofit的同学</p>
<p>关于Retrofit的基本使用可能我们都不是太陌生，对于请求后的结果都是在一个回调接口里接收，对于结果的处理并不是太灵活，一大堆的回调会让你以后回过来看代码的时候看的醉生梦死。<br>RxJava很好的解决了这个问题，我们来看看Retrofit的怎么去适配RxJava吧。</p>
<p>gradle文件的引用<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">compile 'com.squareup.retrofit2:retrofit:2.0.2'</div><div class="line">compile 'com.squareup.retrofit2:converter-gson:2.0.2'</div><div class="line">compile 'com.squareup.retrofit2:adapter-rxjava:2.0.2'//RxJava与Retrofit的适配器</div></pre></td></tr></table></figure></p>
<p>这里我以请求 <a href="http://gank.io/api/data/Android/10/1" target="_blank" rel="external">http://gank.io/api/data/Android/10/1</a> 为例。</p>
<p>返回的结果大致是这样的<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://upload-images.jianshu.io/upload_images/623504-0605a63e05ab2f33.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure></p>
<p>于是我定义了一个GankResultBean去接收这个结果。<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://upload-images.jianshu.io/upload_images/623504-62967f0fabf00980.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure></p>
<p>其中ResultsBean就是results中的每一个条目。<br>好了，下面我们来看看适配了RxJava的Retrofit怎么去使用吧<br>首先我们定义一个接口<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public interface RxGankService &#123;</div><div class="line">       @GET("all/20/&#123;page&#125;")</div><div class="line">       Observable<span class="tag">&lt;<span class="name">GankResultBean</span>&gt;</span> getAndroidData(@Path("page") int page);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>值得注意的是这里返回的是<code>Observable<gankresultbean></gankresultbean></code>而不是常规的<code> Call<gankresultbean></gankresultbean></code></p>
<p>接着就可以做请求了<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"> Retrofit retrofit = new Retrofit.Builder()</div><div class="line">                .baseUrl("http://gank.io/api/data/")</div><div class="line">                .addConverterFactory(GsonConverterFactory.create())</div><div class="line">                .addCallAdapterFactory(RxJavaCallAdapterFactory.create())//这个就是用来适配RxJava的</div><div class="line">                .build();</div><div class="line"></div><div class="line">RxGankService rxGankService = retrofit.create(RxGankService.class);</div><div class="line">        final Observable&lt;GankResultBean&gt; observable = rxGankService.getAndroidData(1);</div><div class="line">        observable</div><div class="line">                .subscribeOn(Schedulers.io())</div><div class="line">                .observeOn(AndroidSchedulers.mainThread())</div><div class="line">                .map(new Func1&lt;GankResultBean, List&lt;GankResultBean.ResultsBean&gt;&gt;() &#123;</div><div class="line">                    @Override</div><div class="line">                    public List&lt;GankResultBean.ResultsBean&gt; call(GankResultBean gankResultBean) &#123;</div><div class="line">                        return gankResultBean.getResults();</div><div class="line">                    &#125;</div><div class="line">                &#125;)</div><div class="line">                .flatMap(new Func1&lt;List&lt;GankResultBean.ResultsBean&gt;, Observable&lt;GankResultBean.ResultsBean&gt;&gt;() &#123;</div><div class="line">                    @Override</div><div class="line">                    public Observable&lt;GankResultBean.ResultsBean&gt; call(List&lt;GankResultBean.ResultsBean&gt; resultsBeen) &#123;</div><div class="line">                        return Observable.from(resultsBeen);</div><div class="line">                    &#125;</div><div class="line">                &#125;)</div><div class="line">                .filter(new Func1&lt;GankResultBean.ResultsBean, Boolean&gt;() &#123;</div><div class="line">                    @Override</div><div class="line">                    public Boolean call(GankResultBean.ResultsBean resultsBean) &#123;</div><div class="line">                        return "Android".equals(resultsBean.getType());</div><div class="line">                    &#125;</div><div class="line">                &#125;)</div><div class="line">                .subscribe(new Subscriber&lt;GankResultBean.ResultsBean&gt;() &#123;</div><div class="line">                    @Override</div><div class="line">                    public void onCompleted() &#123;</div><div class="line">                        Log.i("test", "onCompleted");</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    @Override</div><div class="line">                    public void onError(Throwable e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    @Override</div><div class="line">                    public void onNext(GankResultBean.ResultsBean resultsBean) &#123;</div><div class="line">                        textView.append(resultsBean + "\n");</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div></pre></td></tr></table></figure></p>
<p>这里是为了演示才使用了这么多的操作符，在实际使用的时候根据具体情况而定。<br>下面简单解释下上面这段代码<br>observeOn(AndroidSchedulers.mainThread())：订阅者的回调在主线程<br>subscribeOn(Schedulers.io())：订阅发生在io线程<br>map:一般我们不会关心error字段，我们关心的只是results，所以在这里做了一个映射让用户接收的是List<gankresultbean.resultsbean>而不是包含有error的GankResultBean<br>flatMap:让结果一条一条的发射出去，而不是一个集合<br>filter：只接收Type为Android的数据</gankresultbean.resultsbean></p>
<p>以上的例子用流的方式是不是很好的解决了对请求结果的处理，对结果的处理可以做到随心所欲，并且逻辑还很清晰。</p>
<p>以上几个点就是我了解的关于RxJava的应用。如果你还有其他方面的应用，还望补充。</p>
<h2 id="5-RxJava学习的参考资料"><a href="#5-RxJava学习的参考资料" class="headerlink" title="5.RxJava学习的参考资料"></a>5.RxJava学习的参考资料</h2><p>这里我将我学习RxJava以来收集的关于RxJava分享出来，以方便大家的查阅。</p>
<p>学习RxJava的第一手资料,官方的wiki:<a href="https://github.com/ReactiveX/RxJava/wiki" target="_blank" rel="external">wiki</a><br>我学习RxJava看的第一篇文章：<a href="http://gank.io/post/560e15be2dca930e00da1083#toc_1" target="_blank" rel="external">给 Android 开发者的 RxJava 详解</a>(这个大家肯定都知道)<br>大头鬼总结的RxJava学习资料：<strong><a href="https://github.com/lzyzsd/Awesome-RxJava" target="_blank" rel="external">Awesome-RxJava</a></strong><br>RxJava文档中文翻译：<a href="https://github.com/mcxiaoke/RxDocs" target="_blank" rel="external">Rx和RxJava文档中文翻译项目</a></p>
<p>其他：<br><a href="http://rxmarbles.com" target="_blank" rel="external">RxJava操作符图解</a>（需科学上网）<br><a href="http://www.jianshu.com/p/7e28c8216c7d" target="_blank" rel="external">RxJava处理网络连接失败和timer()、interval()、delay()之间的区别</a><br><a href="http://www.jianshu.com/p/943ceaccfdff" target="_blank" rel="external">Architecting Android with RxJava</a><br><a href="http://www.jianshu.com/p/33c548bce571" target="_blank" rel="external">使用RxJava 提升用户体验</a><br><a href="http://www.jianshu.com/p/ca090f6e2fe2" target="_blank" rel="external">用RxJava实现事件总线(Event Bus)</a><br><a href="http://www.introtorx.com/Content/v1.0.10621.0/02_KeyTypes.html" target="_blank" rel="external">Intro to Rx</a><br><a href="http://nerds.weddingpartyapp.com/tech/2014/12/24/implementing-an-event-bus-with-rxjava-rxbus/" target="_blank" rel="external">Implementing an Event Bus With RxJava - RxBus</a><br><a href="http://blog.csdn.net/theone10211024/article/details/50435325" target="_blank" rel="external">可能是东半球最全的RxJava使用场景小结 </a><br><a href="http://www.jianshu.com/p/ce228f517586?utm_campaign=haruki&amp;utm_content=note&amp;utm_medium=reader_share&amp;utm_source=qq" target="_blank" rel="external">RxWeekend——RxJava周末狂欢</a></p>
<p>最后：为了跟上时代的步伐，是时候学习RxJava了</p>
<p>欢迎关注我的专题：<a href="http://www.jianshu.com/collection/d79a6385bded" target="_blank" rel="external">RxJava系列专题（Android方向）</a></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/04/25/打造一个RecyclerView的万能适配器-减少你的代码冗余/">打造一个RecyclerView的万能适配器-减少你的代码冗余</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017年4月25日
        </span>
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <p>我们都知道每次在我们使用RecyclerView这样的列表组件的时候，我们都会先去创建一个Adapter，对于RecyclerView的Adapter我们已经不需要对itemView的复用操心了，使用过ListView，GridView的肯定知道，对于ItemView的复用需要我们自己去做。但是对于这个RecyclerView的Adapter我们还是会写很多重复的代码，在ViewHolder中也会有很多的FindViewById()这样的代码在里面，写一次无所谓，但是如果我们的项目里面需要写很多个这样的Adapter的时候呢？如果“不偷下懒”，我相信你会写的醉生梦死。</p>
<p>先说明下：本文的思想是基于HongYang的这篇博客：<a href="http://blog.csdn.net/lmj623565791/article/details/38902805" target="_blank" rel="external">Android 快速开发系列 打造万能的ListView GridView 适配器 </a>，他的是基于ListView，GridView的。本文并没有什么技术含量，只是一种简单的封装而已。<br>我们来看看怎么去实现这个适配器吧（下面代码可直接拷贝使用）：</p>
<pre>
/**
 * Created by _SOLID
 * Date:2016/4/5
 * Time:11:18
 * <p>
 * 通用的RecyclerView的适配器
 * </p><p>
 * 思想上参考了Hongyang的 http://blog.csdn.net/lmj623565791/article/details/38902805这篇博客
 */
public abstract class SolidRVBaseAdapter<t> extends RecyclerView.Adapter<solidrvbaseadapter.solidcommonviewholder> {

    protected List<t> mBeans;
    protected Context mContext;
    protected boolean mAnimateItems = true;
    protected int mLastAnimatedPosition = -1;

    public SolidRVBaseAdapter(Context context, List<t> beans) {
        mContext = context;
        mBeans = beans;
    }

    @Override
    public SolidRVBaseAdapter.SolidCommonViewHolder onCreateViewHolder(ViewGroup parent, int viewType) {
        LayoutInflater inflater = LayoutInflater.from(mContext);
        View view = inflater.inflate(getItemLayoutID(viewType), parent, false);
        SolidCommonViewHolder holder = new SolidCommonViewHolder(view);
        return holder;
    }


    @Override
    public void onBindViewHolder(SolidRVBaseAdapter.SolidCommonViewHolder holder, int position) {
        runEnterAnimation(holder.itemView, position);
        onBindDataToView(holder, mBeans.get(position));

    }

    /**
     * 绑定数据到Item的控件中去     *
     * @param holder
     * @param bean
     */
    protected abstract void onBindDataToView(SolidCommonViewHolder holder, T bean);

    /**
     * 取得ItemView的布局文件     *
     * @return
     */
    public abstract int getItemLayoutID(int viewType);


    @Override
    public int getItemCount() {
        return mBeans.size();
    }

    public void add(T bean) {
        mBeans.add(bean);
        notifyDataSetChanged();
    }

    public void addAll(List<t> beans) {
        mBeans.addAll(beans);
        notifyDataSetChanged();
    }

    public void clear() {
        mBeans.clear();
        notifyDataSetChanged();
    }

    /***
     * item的加载动画
     * @param view
     * @param position
     */
    private void runEnterAnimation(View view, int position) {
        if (!mAnimateItems) {
            return;
        }
        if (position > mLastAnimatedPosition) {
            mLastAnimatedPosition = position;
            view.setTranslationY(ViewUtils.getScreenHeight(mContext));
            view.animate()
                    .translationY(50)
                    .setStartDelay(100)
                    .setInterpolator(new DecelerateInterpolator(3.f))
                    .setDuration(300)
                    .start();
        }
    }


    public class SolidCommonViewHolder extends
            RecyclerView.ViewHolder {
        private final SparseArray<view> mViews;
        private View itemView;

        public SolidCommonViewHolder(View itemView) {
            super(itemView);
            this.mViews = new SparseArray<>();
            this.itemView = itemView;
            //添加Item的点击事件
            itemView.setOnClickListener(new View.OnClickListener() {
                @Override
                public void onClick(View v) {
                    onItemClick(getAdapterPosition());
                }
            });
        }


        public <t extends="" view=""> T getView(int viewId) {

            View view = mViews.get(viewId);
            if (view == null) {
                view = itemView.findViewById(viewId);
                mViews.put(viewId, view);
            }
            return (T) view;
        }

        public void setText(int viewId, String text) {
            TextView tv = getView(viewId);
            tv.setText(text);
        }

        /**
         * 加载drawable中的图片
         *
         * @param viewId
         * @param resId
         */
        public void setImage(int viewId, int resId) {
            ImageView iv = getView(viewId);
            iv.setImageResource(resId);
        }

        /**
         * 加载网络上的图片
         *
         * @param viewId
         * @param url
         */
        public void setImageFromInternet(int viewId, String url) {
            ImageView iv = getView(viewId);
            SolidHttpUtils.getInstance().loadImage(url, iv);//这里可根据自己的需要变更
        }
    }

    /**
     * ItemView的单击事件(如果需要，重写此方法就行)
     *
     * @param position
     */
    protected void onItemClick(int position) {

    }
}
</t></view></t></t></t></solidrvbaseadapter.solidcommonviewholder></t></p></pre>

<p>这里我们用到了泛型，如果还有不知道泛型的同学那就赶快去补补泛型这方面的基本知识吧，在面向对象程序设计中泛型这个点还是很重要的。细心的肯定注意到了这是个抽象类，里面有getItemLayoutID和onBindDataToView两个抽象方法，getItemLayoutID是用来设置itemView的布局文件的，onBindDataToView是用来绑定数据到itemView中的控件中去。分别在<strong>onCreateViewHolder</strong>和<strong>onBindViewHolder</strong>中使用到了。这两个方法里面的代码其实并不复杂，我就不多说了，此外我还添加了add、addAll、clear这三个方法用来对数据进行操作。其中<strong>runEnterAnimation</strong>是用来添加ItemView的进入动画的（动画的具体效果可根据需求或者自己的喜欢调整）</p>
<p>比较重要的还是<strong>SolidCommonViewHolder </strong>这个类，这里是我们减少冗余代码的关键。这里使用到了<strong>SparseArray</strong>来保存View（不要问我为什么，这个是Google推荐使用的，和HashMap有点类似，但是在Android中性能要稍微好一些）。我们知道在我们的ItemView中无非是TextView，ImageView这些控件，所以在这里我提供了setText、setImage、setImageFromInternet这几个方法。如果你有更多的控件在ItemView中，请自行添加相关方法。</p>
<p>我们来看看怎么去使用吧</p>
<pre>
/**
 * Created by _SOLID
 * Date:2016/4/5
 * Time:11:34
 */
public class BookAdapter extends SolidRVBaseAdapter<bookbean> {

    public BookAdapter(Context context, List<bookbean> beans) {
        super(context, beans);
    }

    @Override
    public int getItemLayoutID(int vieWType) {
        return R.layout.item_book;
    }

    @Override
    protected void onItemClick(int position) {
        Intent intent = new Intent(mContext, BookDetailActivity.class);
        intent.putExtra("url", mBeans.get(position - 1).getUrl());
        mContext.startActivity(intent);
    }
    @Override
    protected void onBindDataToView(SolidCommonViewHolder holder, BookBean bean) {
        holder.setText(R.id.tv_title, bean.getTitle());
        holder.setText(R.id.tv_price, "￥" + bean.getPrice());
        holder.setText(R.id.tv_author, "作者:" + bean.getAuthor() + "");
        holder.setText(R.id.tv_date, "出版日期:" + bean.getPubdate());
        holder.setText(R.id.tv_publisher, "出版社:" + bean.getPublisher());
        holder.setText(R.id.tv_num_rating, bean.getRating().getNumRaters() + "人评分");
        holder.setImageFromInternet(R.id.iv_image, bean.getImage());
    }
}
</bookbean></bookbean></pre>

<p>是不是很简单，我们只需去设置一个ItemLayoutID然后绑定数据到控件中去就OK了，再也不用去各种FindViewById了。</p>
<p>到这里可能有的同学肯定会问了，你这个只支持只有一个ViewType的RecyclerView啊，要是我有多个改怎么办呢。其实也不难，请看下面代码：</p>
<pre>

/**
 * Created by _SOLID
 * Date:2016/4/5
 * Time:17:36
 * <p>
 * 支持多种ItemType的Adapter（适用于RecyclerView）
 */
public abstract class SolidMultiItemTypeRVBaseAdapter1<t> extends SolidRVBaseAdapter<t> {


    public SolidMultiItemTypeRVBaseAdapter1(Context context, List<t> beans) {
        super(context, beans);
    }
    @Override
    public abstract int getItemViewType(int position);


}

</t></t></t></p></pre>

<p>这个类就是继承于之前写的那个类，在这里我只将RecyclerView.Adapter的getItemViewType这个方法变成了抽象方法。目的是强迫子类根据自己的需求去实现即可,实现类中的onBindDataToView方法根据holder.getItemViewType()去绑定数据即可（这里我没有实际去测试过，就不贴测试代码了）。只要你知道之前那个类中的这个方法，我相信你肯定就会懂了。<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://upload-images.jianshu.io/upload_images/623504-8f8b053b0926b6f2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure></p>

        
      
    </div>

    

    

  </article>

    
  </section>

  
  <nav class="pagination">
    
    
      <a class="next" href="/page/2/">
        <span class="next-text">下一页</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


          </div>
          

        </div>  
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:your@email.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
    
      
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2015 - 
    
    2017

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">_SOLID</span>
  </span>
</div>
      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  


    <script type="text/javascript" src="/js/src/even.js?v=2.4.x"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.4.x"></script>

    
  </body>
</html>
