<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="_SOLID的个人博客">
<meta property="og:url" content="http://www.solidev.me/index.html">
<meta property="og:site_name" content="_SOLID的个人博客">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="_SOLID的个人博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.solidev.me/"/>





  <title>_SOLID的个人博客</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">_SOLID的个人博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.solidev.me/2017/04/06/自定义ItemDecoration这个问题你真的注意到了吗/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="_SOLID">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="_SOLID的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/06/自定义ItemDecoration这个问题你真的注意到了吗/" itemprop="url">
                  自定义ItemDecoration这个问题你真的注意到了吗
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-06T16:14:00+08:00">
                2017-04-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>本文讨论的是关于自定义ItemDecoration容易被忽略的问题，此文适合有过自定义ItemDecoration经验的同学阅读，还没有学习过的可以先去看看相关文章再来看本文。</p>
</blockquote>
<p><strong>ItemDecoration</strong> 我相信只要使用过RecyclerView的同学肯定都比较熟悉了，我们在使用 <strong>RecyclerView</strong> 的时候一般都是用这个来画分隔线的，不得不说十分的好用。但是在最近发现在使用自定义的<strong>ItemDecoration</strong>上遇到了一些细节上的问题，我这里自定义了一个<strong>GridDividerItemDecoration</strong> ，用于网格布局的分隔，大概效果如下图所示：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/623504-79211e4d8ae74ee9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p><strong>绘制的逻辑大概是这样的：当 itemView 不是最后一列或者最后一行的时候就绘制右侧和底部分隔线，如果是最后一列时则不绘制右侧分隔线，如果是最后一行则不绘制底部分隔线。</strong></p>
<p>代码大概是这样的<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">if (isLastRow &amp;&amp; isLastColumn) &#123;//最后一行最后一列什么都不绘制</div><div class="line">    outRect.set(0, 0, 0, 0);</div><div class="line">&#125; else if (isLastRow) &#123;// 如果是最后一行，则不需要绘制底部</div><div class="line">    outRect.set(0, 0, mDividerHeight, 0);</div><div class="line">&#125; else if (isLastColumn) &#123;// 如果是最后一列，则不需要绘制右边</div><div class="line">    outRect.set(0, 0, 0, mDividerHeight);</div><div class="line">&#125; else &#123;</div><div class="line">    outRect.set(0, 0, mDividerHeight,</div><div class="line">            mDividerHeight);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里的分割线设置的宽度只有1dp，看起来似乎没有什么问题，但是如果把分隔线的宽度设置为20dp效果如下图所示：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/623504-622640741f5eba50.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>会明显的感觉到最后一列itemView的宽度会比前几列宽一些，具体的数值就是我们设置的 dividerWidth （也就是分隔线的宽度），正常情况下我们在自定义的 ItemDocration 设置 ItemOffsets 不会影响 itemView 的的大小，然而这里却出现了这个问题（其实网上绝大部分流行的关于网格的ItemDocration都存在这个问题），什么原因呢，看看下面两段源码就会知道了<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">private void measureChild(View view, int otherDirParentSpecMode, boolean alreadyMeasured) &#123;</div><div class="line">       final LayoutParams lp = (LayoutParams) view.getLayoutParams();</div><div class="line">       final Rect decorInsets = lp.mDecorInsets;</div><div class="line">       final int verticalInsets = decorInsets.top + decorInsets.bottom</div><div class="line">               + lp.topMargin + lp.bottomMargin;</div><div class="line">       final int horizontalInsets = decorInsets.left + decorInsets.right</div><div class="line">               + lp.leftMargin + lp.rightMargin;</div><div class="line">       final int availableSpaceInOther = getSpaceForSpanRange(lp.mSpanIndex, lp.mSpanSize);</div><div class="line">       final int wSpec;</div><div class="line">       final int hSpec;</div><div class="line">       if (mOrientation == VERTICAL) &#123;</div><div class="line">           //最后一个参数用来标识在当前的mOrientation 下是否可以滚动，</div><div class="line">           //当mOrientation 是VERTICAL的时候水平方向肯定是不能滚动的</div><div class="line">           wSpec = getChildMeasureSpec(availableSpaceInOther, otherDirParentSpecMode,</div><div class="line">                   horizontalInsets, lp.width, false);</div><div class="line">           hSpec = getChildMeasureSpec(mOrientationHelper.getTotalSpace(), getHeightMode(),</div><div class="line">                   verticalInsets, lp.height, true);</div><div class="line">       &#125; else &#123;</div><div class="line">           hSpec = getChildMeasureSpec(availableSpaceInOther, otherDirParentSpecMode,</div><div class="line">                   verticalInsets, lp.height, false);</div><div class="line">           wSpec = getChildMeasureSpec(mOrientationHelper.getTotalSpace(), getWidthMode(),</div><div class="line">                   horizontalInsets, lp.width, true);</div><div class="line">       &#125;</div><div class="line">       measureChildWithDecorationsAndMargin(view, wSpec, hSpec, alreadyMeasured);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">public static int getChildMeasureSpec(int parentSize, int parentMode, int padding,</div><div class="line">                int childDimension, boolean canScroll) &#123;</div><div class="line">            int size = Math.max(0, parentSize - padding);</div><div class="line">            int resultSize = 0;</div><div class="line">            int resultMode = 0;</div><div class="line">            if (canScroll) &#123;</div><div class="line">                if (childDimension &gt;= 0) &#123;</div><div class="line">                    resultSize = childDimension;</div><div class="line">                    resultMode = MeasureSpec.EXACTLY;</div><div class="line">                &#125; else if (childDimension == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">                    switch (parentMode) &#123;</div><div class="line">                        case MeasureSpec.AT_MOST:</div><div class="line">                        case MeasureSpec.EXACTLY:</div><div class="line">                            resultSize = size;</div><div class="line">                            resultMode = parentMode;</div><div class="line">                            break;</div><div class="line">                        case MeasureSpec.UNSPECIFIED:</div><div class="line">                            resultSize = 0;</div><div class="line">                            resultMode = MeasureSpec.UNSPECIFIED;</div><div class="line">                            break;</div><div class="line">                    &#125;</div><div class="line">                &#125; else if (childDimension == LayoutParams.WRAP_CONTENT) &#123;</div><div class="line">                    resultSize = 0;</div><div class="line">                    resultMode = MeasureSpec.UNSPECIFIED;</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                if (childDimension &gt;= 0) &#123;</div><div class="line">                    resultSize = childDimension;</div><div class="line">                    resultMode = MeasureSpec.EXACTLY;</div><div class="line">                &#125; else if (childDimension == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">                    resultSize = size;</div><div class="line">                    resultMode = parentMode;</div><div class="line">                &#125; else if (childDimension == LayoutParams.WRAP_CONTENT) &#123;</div><div class="line">                    resultSize = size;</div><div class="line">                    if (parentMode == MeasureSpec.AT_MOST || parentMode == MeasureSpec.EXACTLY) &#123;</div><div class="line">                        resultMode = MeasureSpec.AT_MOST;</div><div class="line">                    &#125; else &#123;</div><div class="line">                        resultMode = MeasureSpec.UNSPECIFIED;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            //noinspection WrongConstant</div><div class="line">            return MeasureSpec.makeMeasureSpec(resultSize, resultMode);</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>由于我们这里讨论的是垂直方向上的Grid，所以 <strong>mOrientation == VERTICA</strong>，从上面的代码可以看出当我们的itemView宽度不是精确数值的时候，然后测量出的宽度就为 <strong> Math.max(0, parentSize - padding)</strong>（这里的 padding 就是 <code>horizontalInsets = decorInsets.left + decorInsets.right + lp.leftMargin + lp.rightMargin</code>），原来这里在实际的宽度下还减去了ItemDecoration的左右偏移量，这也就解释了上面的那个问题。有人会问我们可不可以把宽度设置为固定值呢？可以当然是可以的，但是又会出现其他问题，下来你可以去尝试一下，这里我就不再去细究了。</p>
<p>一般情况下当 mOrientation == VERTICA 的时候itemView的宽度是 match_parent的，当 mOrientation == HORIZONTAL的时候itemView的高度就是 match_parent的，这样才能更好的去适配各种屏幕的手机。</p>
<p>这里我们找到了问题的原因所在，应该怎样去解决呢？  其实也很简单，就是均匀的分配offset给每一个itemView。</p>
<p>下面我们来计算一下偏移量。</p>
<p>// 每一个itemView的总偏移量（left+right）<br>eachOffset =（spanCount-1）* dividerWidth / spanCount;</p>
<p>L0=0 , R0=eachOffset;<br>L1=dividerWidth-R0 , R1=eachOffset-L1;<br>L2=dividerWidth-R1 , R2=eachOffset-L2;</p>
<p>其中：<br>L<sub>n</sub>:表示第n列itemView  left 偏移量。<br>R<sub>n</sub>:表示第n列itemView  right 偏移量。</p>
<p>可能有些同学看到上面式子会有点凌乱，这里我直接告诉你最后推算出的结论好了，L<sub>n</sub> 是一个以 <strong>dividerWidth-eachOffset</strong> 为差值的一个等差数列，R<sub>n</sub>就等于 <strong>eachWidth-L<sub>n</sub></strong>。所以我们最后对 getItemOffsets 做了改进，代码如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">int left = 0;</div><div class="line">int top = 0;</div><div class="line">int right = 0;</div><div class="line">int bottom = 0;</div><div class="line">int eachWidth = (spanCount - 1) * mDividerHeight / spanCount;</div><div class="line">int dl = mDividerHeight - eachWidth;</div><div class="line"></div><div class="line">left = itemPosition % spanCount * dl;</div><div class="line">right = eachWidth - left;</div><div class="line">bottom = mDividerHeight;</div><div class="line"></div><div class="line">if (isLastRow) &#123;</div><div class="line">    bottom = 0;</div><div class="line">&#125;</div><div class="line">outRect.set(left, top, right, bottom);</div></pre></td></tr></table></figure>
<p>最后的效果图如下：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/623504-36ce8945af500155.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>完美的解决了上面出现的问题，这都是些细节上的问题，如果不怎么注意，还真的很难去注意到，以后如果遇到其他类似的问题也可以很容易的解决了。本文只是讨论了在使用ItemDecoration其中的一个问题，并不算难，但是也很重要，所以大家在平时的开发中还是应该多多注意细节上的问题。</p>
<p>最后送上本文源码地址:</p>
<ol>
<li><a href="https://github.com/burgessjp/QuickDevLib/blob/master/library/src/main/java/me/solidev/library/ui/recyclerview/GridDividerItemDecoration.java" target="_blank" rel="external">GridDividerItemDecoration</a></li>
</ol>
<ul>
<li><a href="https://github.com/burgessjp/QuickDevLib/blob/master/library/src/main/java/me/solidev/library/ui/recyclerview/GridDividerItemDecorationBug.java" target="_blank" rel="external">GridDividerItemDecorationBug</a></li>
</ul>
<p>顺便给大家推荐一个十分强大的开源自定义的ItemDecoration ，适用于 <strong>LinearLayoutManager</strong>作为布局管理器的RecyclerView : <a href="https://github.com/yqritc/RecyclerView-FlexibleDivider" target="_blank" rel="external">RecyclerView-FlexibleDivider</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.solidev.me/2016/12/04/[干货IO-3-0]-一个完全开源的App/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="_SOLID">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="_SOLID的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/04/[干货IO-3-0]-一个完全开源的App/" itemprop="url">
                  干货IO 3.0一个完全开源的App
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-12-04T21:46:00+08:00">
                2016-12-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前写过一篇关于介绍[干货IO]的文章<a href="http://www.jianshu.com/p/3f137269a942" target="_blank" rel="external">基于Gank.IO提供的API的第三方客户端，可以在线收藏[项目开源]</a>，大致介绍了用到了什么，有哪些功能，一句话就是让大家知道了这个app的存在，之后了一段时间对app也在一直维护，有过好几次的更新，但是改动程度都不是太大，改的最大的一次就是重构底层的网络请求，但并不是太彻底，所以也遗留下了一些问题，其他的就是一些小功能的增增改改。<br>之所以再次写关于<strong>[干货IO]</strong>的文章，就是想纪录一下做这个app的心路历程，以及介绍一下里面的技术实现。</p>
<p><strong>在这里再次感谢一下<a href="https://github.com/daimajia" target="_blank" rel="external">daimajia</a>，没有<a href="http://gank.io/" target="_blank" rel="external">gank.io</a>就不会有这个app的存在，如果还有不知道的可以每天都去这个网站看看，除了周六周末两天不更新之外，每天都会有技术干货的推送更新。</strong></p>
<p>先说下这个3.0版本更新的主要内容吧</p>
<ul>
<li>1.UI风格大调整，全新的 UI 风格</li>
<li>2.支持干货配图</li>
<li>3.新增 gank 最近推出的闲读</li>
<li>4.新增搜索</li>
<li>5.修复仅Wifi加载图片的bug</li>
<li>6.行为更改：长按干货收藏</li>
</ul>
<p>下面是应用部分截图：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/623504-b825a653dee193d7.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/300" alt="p1"><br><img src="http://upload-images.jianshu.io/upload_images/623504-430e5c355e524eca.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/300" alt="p2.jpg"><br><img src="http://upload-images.jianshu.io/upload_images/623504-a0a8c1ba87cc46c6.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/300" alt="p3.jpg"></p>
<p>为了不影响文章的可读性，这里就不放太多的截图了，感兴趣的可以去安装体验。</p>
<hr>
<p>好了，开始正题。</p>
<h3 id="干货IO-1-0"><a href="#干货IO-1-0" class="headerlink" title="干货IO 1.0"></a>干货IO 1.0</h3><p>大概是今年3月份的时候关注了gan.io这个网站，这上面每天都会提供很多的技术干货，后面的时间我也是受益良多，与此同时也知道了drakeet为之做的一个 App <a href="https://github.com/drakeet/Meizhi" target="_blank" rel="external">Meizhi</a>，这个App最近好像有更新，非常好的一个开源项目，从这个项目中我也学到了很多。众所周知，gan.io是客户端最多的一个网站，应用市场一搜索就可以搜到很多关于gank的应用，但这些应用都有一个共同点，没有收藏功能，我个人感觉收藏功能还是比较重要的，他可以防止以后想回过来再看的时候不用花太多的时间去一页一页的找，这个就是我最开始想做这个App的的主要动机。于是就有了 <strong>干货IO 1.0</strong> 的出现，也是一个完全开源项目，在今年五月份就提交到了github，只有查看最新干货，分类浏览和收藏三个功能，只能说达到了预期目标，做的相对而言也比较的粗糙，App并不是那么流畅。</p>
<p>1.0系列版本有过好几次更新，大多改动都不太大，基本上都是些bug的修复和一些小功能的增加，最大的一次改动就是使用 RxJava + Retrofit + MVP重构这个项目了，底层的代码改动算是比较大的，由于时间上的原因这次重构并不是太彻底，也因此造成了代码的混乱。说到这里我们来简单说说RxJava 、 Retrofit 、 MVP这三个技术吧，我相信大家对这三个技术肯定也不陌生。</p>
<p>RxJava可以以流的方式去处理我们的数据，线程的切换上也是十分的方便，可以大大减少代码量，网络上也涌现出了相关的库，很大程度上方便了我们的开发，RxJava相关的文章可以去我管理的专题看看 <a href="http://www.jianshu.com/collection/d79a6385bded" target="_blank" rel="external">RxJava系列专题（Android方向）</a>，这个专题基本上收录完了简书上关于RxJava最好的文章，当然，你有相关的比较好的文章也可以往这个专题投稿。</p>
<p>Retrofit是Square公司出品的又一大神器，一个高质量的http库，现在十分流行，网上关于他的文章也是多不胜数，他极大化的简化了我们的网络请求，使得我们的代码更加可读，以及方便后期的维护，加上RxJava简直就是完美 。</p>
<p>MVP是Android目前比较受欢迎的一种设计模式，个人感觉这个库比较适合于多人共同维护开发的大项目，一般的项目用MVP开发，会多出很多的类文件，有点影响开发效率，1.0版本就试过用MVP去重构项目，最后发现大大增大了我们的工作量，本来很快就能完成的一个功能，增加了很多的类文件，最后到了3.0版本我果断去掉了MVP（还残留了一部分）。项目开发的时候应该实际情况去选择设计模式，而不是盲目的套用现在十分流行的。</p>
<h3 id="干货IO-2-0"><a href="#干货IO-2-0" class="headerlink" title="干货IO 2.0"></a>干货IO 2.0</h3><p>这个版本在功能上其实没什么改变，只是调整了一下UI，把侧滑菜单中的部门功能放到了底部选项卡中，加入了谷歌最新推出的<strong>BottomNavigationBar</strong>。</p>
<h3 id="干货IO-3-0"><a href="#干货IO-3-0" class="headerlink" title="干货IO 3.0"></a>干货IO 3.0</h3><p>这个版本变化时比较大的，断断续续的花了我一周的时间去做，基本上是完全重构之前所有的代码，这次的重构是的代码更加的干净，比较有学习的价值，网络请求完全采用Retrofit+RxJava，网络请求也更加的清晰可控，新增了搜索和闲读，干货有了Gif配图，应用也更具MD的风格，在这里必须感谢下<a href="https://github.com/ryanhoo/Android-Proficiency-Exercise" target="_blank" rel="external">Android-Proficiency-Exercise</a>，分类列表的UI样式就来源于他。刚开始在做gif图加载的时候，加载十分的慢，并且内存使用也十分的大，最后经过查阅资料把Glide的缓存策略改为<code>DiskCacheStrategy.SOURCE</code>就可以了。列表的Adapter使用的是drakeet的<a href="https://github.com/drakeet/MultiType" target="_blank" rel="external">MultiType</a>，这个库处理含有多种itemType的RecyclerView非常的棒！如果还不知道这个库的，我强烈推荐使用。同时我基于<a href="https://github.com/drakeet/MultiType" target="_blank" rel="external">MultiType</a>也封装了一个通用列表的抽象类，很简单的就能实现一个列表，添加头部这个都不是事，最简单的列表只需实现loadData方法。<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public void loadData(final int pageIndex) &#123;</div><div class="line">    ServiceFactory.getInstance().createService(GankService.class)</div><div class="line">            .getGanHuo(mType, pageIndex)</div><div class="line">            .compose(TransformUtils.&lt;HttpResult&lt;List&lt;GanHuoDataBean&gt;&gt;&gt;defaultSchedulers())</div><div class="line">            .subscribe(new Subscriber&lt;HttpResult&lt;List&lt;GanHuoDataBean&gt;&gt;&gt;() &#123;</div><div class="line">                @Override</div><div class="line">                public void onCompleted() &#123;</div><div class="line"></div><div class="line">                &#125;</div><div class="line"></div><div class="line">                @Override</div><div class="line">                public void onError(Throwable e) &#123;</div><div class="line">                    showError(new Exception(e));</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                @Override</div><div class="line">                public void onNext(HttpResult&lt;List&lt;GanHuoDataBean&gt;&gt; listHttpResult) &#123;</div><div class="line">                    onDataSuccessReceived(pageIndex, listHttpResult.results);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的代码来源于分类列表Fragment，具体的实现可以去看文章末尾的源码。好了差不多就是这些了，这里贴代码也没有什么意义，反而影响文章的可阅读性，用到了哪些技术文章中也提到了，这个App综合了我前面好几篇博客的内容，也算是对之前讲解的技术的一个综合应用，并且应用是完全开源的，阅读源码可以看到更多的技术细节实现，反而更直接有效。如果在使用过程中发现有bug，非常欢迎反馈，我会继续维护这个项目。<br>写到这里突然感觉自己逼逼了好多的废话，轻喷~~~</p>
<h3 id="特别感谢"><a href="#特别感谢" class="headerlink" title="特别感谢"></a>特别感谢</h3><p><a href="https://github.com/daimajia" target="_blank" rel="external">daimajia</a>、<a href="https://github.com/drakeet" target="_blank" rel="external">drakeet</a>、<a href="https://github.com/ryanhoo/Android-Proficiency-Exercise" target="_blank" rel="external">Android-Proficiency-Exercise</a></p>
<p>应用体验下载地址:<a href="http://android.myapp.com/myapp/detail.htm?apkName=ren.solid.ganhuoio" target="_blank" rel="external">点击下载</a><br>源码传送门：<a href="https://github.com/burgessjp/GanHuoIO" target="_blank" rel="external">GanHuoIO</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.solidev.me/2016/10/25/分享一种RecyclerView滑动到底部自动加载的实现方案/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="_SOLID">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="_SOLID的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/25/分享一种RecyclerView滑动到底部自动加载的实现方案/" itemprop="url">
                  分享一种RecyclerView滑动到底部自动加载的实现方案
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-25T16:06:00+08:00">
                2016-10-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在我们开发app的时候，列表组件总是最常用的。目前<strong>下拉刷新</strong>和<strong>上拉加载</strong>的组件有很多。Github一搜索，大部分的开源项目都只实现了<strong>下拉刷新</strong>而没有<strong>上拉加载</strong>，也有部分项目把<strong>上拉加载</strong>更多实现了，但是这样做其实并不好，因为在app实际的运行中当户滑动到底部就应该自动加载下一页的内容（决大部分app都是这样做的），而不是要让用户手动去上拉才会去加载，这样会严重影响到用户体验，当然，个别特殊情况除外。</p>
<p>今天我要讲的内容可能很多人都知道怎么做，搜一搜也会出现很多相应的内容。我这次分享主要的目的是聊聊实现方案和在其中遇到的一些问题，如果有更好的实现方案，望不吝赐教。</p>
<h3 id="1-常规版"><a href="#1-常规版" class="headerlink" title="1.常规版"></a>1.常规版</h3><p>我们都知道RecyclerView可以监听滚动事件的Listener：我们只需实现里面对应的事件就可以实现滑动到底部加载更多了<br>代码实现大概是这样的（这里只考虑了布局管理器是LinearLayoutManager的情况，其他的也类似）：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">recyclerView.addOnScrollListener(new RecyclerView.OnScrollListener() &#123;</div><div class="line">            @Override</div><div class="line">            public void onScrollStateChanged(RecyclerView recyclerView, int newState) &#123;</div><div class="line">                LinearLayoutManager lm = (LinearLayoutManager) recyclerView.getLayoutManager();</div><div class="line">                int totalItemCount = recyclerView.getAdapter().getItemCount();</div><div class="line">                int lastVisibleItemPosition = lm.findLastVisibleItemPosition();</div><div class="line">                int visibleItemCount = recyclerView.getChildCount();</div><div class="line"></div><div class="line">                if (newState == RecyclerView.SCROLL_STATE_IDLE</div><div class="line">                        &amp;&amp; lastVisibleItemPosition == totalItemCount - 1</div><div class="line">                        &amp;&amp; visibleItemCount &gt; 0) &#123;</div><div class="line">                    //加载更多</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure></p>
<p>上面的代码我相信做过自动加载的朋友都很熟悉， 这样做确实能做到自动加载更多，但是如果我们想显示加载的状态（<strong>加载中，加载出错，没有更多了</strong>）怎么办呢？只是用这种方案肯定是不能解决的。</p>
<h3 id="2-进阶版"><a href="#2-进阶版" class="headerlink" title="2.进阶版"></a>2.进阶版</h3><p>我们也都知道RecyclerView不能像ListView那样直接就有addHeadView和addFooterView之类的方法，要想实现加载状态的显示必须要在Adapter上动手脚才行。洋神对此也有了一种实现<a href="https://github.com/hongyangAndroid/baseAdapter/blob/master/baseadapter-recyclerview/src/main/java/com/zhy/adapter/recyclerview/wrapper/LoadmoreWrapper.java" target="_blank" rel="external">LoadmoreWrapper</a>(只是单纯的加载更多，并没有状态的处理)，代码大概是这样的（我只留下了关键部分的代码，想看代码完整实现的请直接点击上面的链接。）：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line">public class LoadMoreWrapper<span class="tag">&lt;<span class="name">T</span>&gt;</span> extends RecyclerView.Adapter<span class="tag">&lt;<span class="name">RecyclerView.ViewHolder</span>&gt;</span></div><div class="line">&#123;</div><div class="line">    public static final int ITEM_TYPE_LOAD_MORE = Integer.MAX_VALUE - 2;</div><div class="line"></div><div class="line">    private RecyclerView.Adapter mInnerAdapter;</div><div class="line">    private View mLoadMoreView;</div><div class="line">    private int mLoadMoreLayoutId;</div><div class="line"></div><div class="line">    public LoadMoreWrapper(RecyclerView.Adapter adapter)</div><div class="line">    &#123;</div><div class="line">        mInnerAdapter = adapter;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    @Override</div><div class="line">    public int getItemViewType(int position)</div><div class="line">    &#123;</div><div class="line">        if (isShowLoadMore(position))</div><div class="line">        &#123;</div><div class="line">            return ITEM_TYPE_LOAD_MORE;</div><div class="line">        &#125;</div><div class="line">        return mInnerAdapter.getItemViewType(position);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public RecyclerView.ViewHolder onCreateViewHolder(ViewGroup parent, int viewType)</div><div class="line">    &#123;</div><div class="line">        if (viewType == ITEM_TYPE_LOAD_MORE)</div><div class="line">        &#123;</div><div class="line">            ViewHolder holder;</div><div class="line">            if (mLoadMoreView != null)</div><div class="line">            &#123;</div><div class="line">                holder = ViewHolder.createViewHolder(parent.getContext(), mLoadMoreView);</div><div class="line">            &#125; else</div><div class="line">            &#123;</div><div class="line">                holder = ViewHolder.createViewHolder(parent.getContext(), parent, mLoadMoreLayoutId);</div><div class="line">            &#125;</div><div class="line">            return holder;</div><div class="line">        &#125;</div><div class="line">        return mInnerAdapter.onCreateViewHolder(parent, viewType);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onBindViewHolder(RecyclerView.ViewHolder holder, int position)</div><div class="line">    &#123;</div><div class="line">        if (isShowLoadMore(position))</div><div class="line">        &#123;</div><div class="line">            if (mOnLoadMoreListener != null)</div><div class="line">            &#123;</div><div class="line">                mOnLoadMoreListener.onLoadMoreRequested();</div><div class="line">            &#125;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        mInnerAdapter.onBindViewHolder(holder, position);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    private OnLoadMoreListener mOnLoadMoreListener;</div><div class="line"></div><div class="line">    public LoadMoreWrapper setOnLoadMoreListener(OnLoadMoreListener loadMoreListener)</div><div class="line">    &#123;</div><div class="line">        if (loadMoreListener != null)</div><div class="line">        &#123;</div><div class="line">            mOnLoadMoreListener = loadMoreListener;</div><div class="line">        &#125;</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到这里巧妙的用到了装饰者模式，完全与数据展示的逻辑分隔，在相应的方法里做了对应判断。加载更多的调用就在<strong>onBindViewHolder</strong>这个方法中，意思就是当这个View显示出来了，我们就触发加载更多这个方法。</p>
<p>但是这里还是没有实现状态的处理。这确实是一个好的方案这样做还是有点不能满足实际开发中的一些需求。并且这样做还有一个潜在的问题：如果你的请求没有延时，也就是说我们直接add的一批数据，然后直接调用了notifyDataSetChanged()方法，就会出下下面的错误：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java.lang.IllegalStateException: Cannot call this method while RecyclerView is computing a layout or scrolling</div></pre></td></tr></table></figure></p>
<h3 id="3-综合版"><a href="#3-综合版" class="headerlink" title="3.综合版"></a>3.综合版</h3><p>上面两种方式各有各的优点，如果我们能将这两种方式结合在一起，那就好了。第一种方式服务加载更多，第二种方式负责状态的显示。下面来看看代码的实现（有省略）：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div></pre></td><td class="code"><pre><div class="line">public class LoadMoreWrapper extends RecyclerView.Adapter<span class="tag">&lt;<span class="name">RecyclerView.ViewHolder</span>&gt;</span> &#123;</div><div class="line"></div><div class="line">    public static final int ITEM_TYPE_LOAD_FAILED_VIEW = Integer.MAX_VALUE - 1;</div><div class="line">    public static final int ITEM_TYPE_NO_MORE_VIEW = Integer.MAX_VALUE - 2;</div><div class="line">    public static final int ITEM_TYPE_LOAD_MORE_VIEW = Integer.MAX_VALUE - 3;</div><div class="line">    public static final int ITEM_TYPE_NO_VIEW = Integer.MAX_VALUE - 4;//不展示footer view</div><div class="line"></div><div class="line">    private Context mContext;</div><div class="line">    private RecyclerView.Adapter mInnerAdapter;</div><div class="line"></div><div class="line">    private View mLoadMoreView;</div><div class="line">    private View mLoadMoreFailedView;</div><div class="line">    private View mNoMoreView;</div><div class="line"></div><div class="line">    private int mCurrentItemType = ITEM_TYPE_LOAD_MORE_VIEW;</div><div class="line">    private LoadMoreScrollListener mLoadMoreScrollListener;</div><div class="line"></div><div class="line"></div><div class="line">    private boolean isLoadError = false;//标记是否加载出错</div><div class="line">    private boolean isHaveStatesView = true;</div><div class="line"></div><div class="line">    public LoadMoreWrapper(Context context, RecyclerView.Adapter adapter) &#123;</div><div class="line">        this.mContext = context;</div><div class="line">        this.mInnerAdapter = adapter;</div><div class="line">        mLoadMoreScrollListener = new LoadMoreScrollListener() &#123;</div><div class="line">            @Override</div><div class="line">            public void loadMore() &#123;</div><div class="line">                if (mOnLoadListener != null &amp;&amp; isHaveStatesView) &#123;</div><div class="line">                    if (!isLoadError) &#123;</div><div class="line">                        showLoadMore();</div><div class="line">                        mOnLoadListener.onLoadMore();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void showLoadMore() &#123;</div><div class="line">        mCurrentItemType = ITEM_TYPE_LOAD_MORE_VIEW;</div><div class="line">        isLoadError = false;</div><div class="line">        isHaveStatesView = true;</div><div class="line">        notifyItemChanged(getItemCount());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void showLoadError() &#123;</div><div class="line">        mCurrentItemType = ITEM_TYPE_LOAD_FAILED_VIEW;</div><div class="line">        isLoadError = true;</div><div class="line">        isHaveStatesView = true;</div><div class="line">        notifyItemChanged(getItemCount());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void showLoadComplete() &#123;</div><div class="line">        mCurrentItemType = ITEM_TYPE_NO_MORE_VIEW;</div><div class="line">        isLoadError = false;</div><div class="line">        isHaveStatesView = true;</div><div class="line">        notifyItemChanged(getItemCount());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void disableLoadMore() &#123;</div><div class="line">        mCurrentItemType = ITEM_TYPE_NO_VIEW;</div><div class="line">        isHaveStatesView = false;</div><div class="line">        notifyDataSetChanged();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //region Get ViewHolder</div><div class="line">    private ViewHolder getLoadMoreViewHolder() &#123;</div><div class="line">        if (mLoadMoreView == null) &#123;</div><div class="line">            mLoadMoreView = new TextView(mContext);</div><div class="line">            mLoadMoreView.setLayoutParams(new ViewGroup.LayoutParams(MATCH_PARENT, WRAP_CONTENT));</div><div class="line">            mLoadMoreView.setPadding(20, 20, 20, 20);</div><div class="line">            ((TextView) mLoadMoreView).setText("正在加载中");</div><div class="line">            ((TextView) mLoadMoreView).setGravity(Gravity.CENTER);</div><div class="line">        &#125;</div><div class="line">        return ViewHolder.createViewHolder(mContext, mLoadMoreView);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private ViewHolder getLoadFailedViewHolder() &#123;</div><div class="line">        if (mLoadMoreFailedView == null) &#123;</div><div class="line">            mLoadMoreFailedView = new TextView(mContext);</div><div class="line">            mLoadMoreFailedView.setPadding(20, 20, 20, 20);</div><div class="line">            mLoadMoreFailedView.setLayoutParams(new ViewGroup.LayoutParams(MATCH_PARENT, WRAP_CONTENT));</div><div class="line">            ((TextView) mLoadMoreFailedView).setText("加载失败，请点我重试");</div><div class="line">            ((TextView) mLoadMoreFailedView).setGravity(Gravity.CENTER);</div><div class="line">        &#125;</div><div class="line">        return ViewHolder.createViewHolder(mContext, mLoadMoreFailedView);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private ViewHolder getNoMoreViewHolder() &#123;</div><div class="line">        if (mNoMoreView == null) &#123;</div><div class="line">            mNoMoreView = new TextView(mContext);</div><div class="line">            mNoMoreView.setPadding(20, 20, 20, 20);</div><div class="line">            mNoMoreView.setLayoutParams(new ViewGroup.LayoutParams(MATCH_PARENT, WRAP_CONTENT));</div><div class="line">            ((TextView) mNoMoreView).setText("--end--");</div><div class="line">            ((TextView) mNoMoreView).setGravity(Gravity.CENTER);</div><div class="line">        &#125;</div><div class="line">        return ViewHolder.createViewHolder(mContext, mNoMoreView);</div><div class="line">    &#125;</div><div class="line">    //endregion</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public int getItemViewType(int position) &#123;</div><div class="line">        if (position == getItemCount() - 1 &amp;&amp; isHaveStatesView) &#123;</div><div class="line">            return mCurrentItemType;</div><div class="line">        &#125;</div><div class="line">        return mInnerAdapter.getItemViewType(position);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public RecyclerView.ViewHolder onCreateViewHolder(ViewGroup parent, int viewType) &#123;</div><div class="line">        if (viewType == ITEM_TYPE_NO_MORE_VIEW) &#123;</div><div class="line">            return getNoMoreViewHolder();</div><div class="line">        &#125; else if (viewType == ITEM_TYPE_LOAD_MORE_VIEW) &#123;</div><div class="line">            return getLoadMoreViewHolder();</div><div class="line">        &#125; else if (viewType == ITEM_TYPE_LOAD_FAILED_VIEW) &#123;</div><div class="line">            return getLoadFailedViewHolder();</div><div class="line">        &#125;</div><div class="line">        return mInnerAdapter.onCreateViewHolder(parent, viewType);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onBindViewHolder(RecyclerView.ViewHolder holder, int position) &#123;</div><div class="line">        if (holder.getItemViewType() == ITEM_TYPE_LOAD_FAILED_VIEW) &#123;</div><div class="line">            mLoadMoreFailedView.setOnClickListener(new View.OnClickListener() &#123;</div><div class="line">                @Override</div><div class="line">                public void onClick(View v) &#123;</div><div class="line">                    if (mOnLoadListener != null) &#123;</div><div class="line">                        mOnLoadListener.onRetry();</div><div class="line">                        showLoadMore();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        mInnerAdapter.onBindViewHolder(holder, position);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onAttachedToRecyclerView(RecyclerView recyclerView) &#123;</div><div class="line">         ...</div><div class="line">         recyclerView.addOnScrollListener(mLoadMoreScrollListener);</div><div class="line">    &#125;</div><div class="line">   ...</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public int getItemCount() &#123;</div><div class="line">        return mInnerAdapter.getItemCount() + (isHaveStatesView ? 1 : 0);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>代码的实现也还是很简单，定义了四种itemType，分别对应<strong>加载失败</strong>、<strong>没有更多了</strong>、<strong>加载中</strong>、<strong>不显示</strong>四种状态，同时也实现了错误重试的处理。在<strong>onAttachedToRecyclerView</strong>回调中去添加LoadMoreScrollListener。<br>完整版代码地址:<a href="https://github.com/burgessjp/QuickDevLib/blob/master/library/src/main/java/me/solidev/library/ui/adapter/wrapper/LoadMoreWrapper.java" target="_blank" rel="external">LoadMoreWrapper</a></p>
<p>说了这么多，怎么用？<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">//把你用的adapter传进去</div><div class="line">LoadMoreWrapper mLoadMoreWrapper=new LoadMoreWrapper (mAdapter);</div><div class="line">mLoadMoreWrapper.setOnLoadListener(new LoadMoreWrapper.OnLoadListener() &#123;</div><div class="line">            @Override</div><div class="line">            public void onRetry() &#123;</div><div class="line">              //重试处理</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            @Override</div><div class="line">            public void onLoadMore() &#123;</div><div class="line">               //加载更多</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">mRecyclerView.setAdapter(mLoadMoreWrapper);</div></pre></td></tr></table></figure></p>
<p>在刷新数据的时候调用一下showLoadMore()，数据加载出错的时候调用一下showLoadError()，数据加载完成的时候调用showLoadComplete()。</p>
<p>想看Demo的请看这里:<a href="https://github.com/burgessjp/QuickDevLib/blob/master/library/src/main/java/me/solidev/library/ui/fragment/AbsListFragment.java" target="_blank" rel="external">AbsListFragment</a>，这是我封装了一个通用的列表展示Fragment。</p>
<p>Over.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.solidev.me/2016/09/22/在Android中使用Realm作本地存储/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="_SOLID">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="_SOLID的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/22/在Android中使用Realm作本地存储/" itemprop="url">
                  在Android中使用Realm作本地存储
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-09-22T17:00:00+08:00">
                2016-09-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Android平台有很多的orm框架可以对数据作本地存储，比如ormlite、greenDao、SugarORM等等，这些orm框架基本都是基于sqlite的。今天我要介绍的这个数据库Realm，是用来替代sqlite的一种解决方案，它有一套自己的数据库存储引擎，比sqlite更轻量级，拥有更快的速度，最重要的是跨平台，目前已有Java，Objective C，Swift，React-Native，Xamarin这五种实现。<br>本文是Realm数据库在Android中使用的一个入门级的教程，这里不对Realm与其他的orm框架的优缺点作讨论（这些网上已是一搜一大把）。</p>
<blockquote>
<p>本文学习目录<br>一.环境配置<br>二.创建实体<br>三.CRUD（增删改查操作）<br>四.进阶用法</p>
</blockquote>
<h3 id="一-环境配置"><a href="#一-环境配置" class="headerlink" title="一.环境配置"></a>一.环境配置</h3><ol>
<li><p>在项目的build文件加上</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">buildscript &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">    dependencies &#123;</div><div class="line">        ...</div><div class="line">        classpath "io.realm:realm-gradle-plugin:1.2.0"</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>在 app 的 build文件中加入</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">apply plugin: 'realm-android'</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="二-创建实体"><a href="#二-创建实体" class="headerlink" title="二.创建实体"></a>二.创建实体</h3><p>Realm 支持的字段类型，除了Java提供的基本类型之外，Realm还支持<code>继承了RealmObject 的对象</code>和<code>RealmList&lt;? extends RealmObject&gt;</code></p>
<p>这里为了方便直接使用了示例项目中的对象了。</p>
<p>创建一个User实体<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">public class User extends RealmObject &#123;</div><div class="line">    @PrimaryKey</div><div class="line">    private String id;</div><div class="line">    private String name;</div><div class="line">    private int age;</div><div class="line">    private RealmList<span class="tag">&lt;<span class="name">User</span>&gt;</span> friends;</div><div class="line"></div><div class="line">    public String getName() &#123;</div><div class="line">        return name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setName(String name) &#123;</div><div class="line">        this.name = name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public int getAge() &#123;</div><div class="line">        return age;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setAge(int age) &#123;</div><div class="line">        this.age = age;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public String getId() &#123;</div><div class="line">        return id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setId(String id) &#123;</div><div class="line">        this.id = id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public RealmList<span class="tag">&lt;<span class="name">User</span>&gt;</span> getFriends() &#123;</div><div class="line">        return friends;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setFriends(RealmList<span class="tag">&lt;<span class="name">User</span>&gt;</span> friends) &#123;</div><div class="line">        this.friends = friends;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>细心的同学已经注意到了，我们上面创建的实体对象继承于RealmObject ，Realm 数据实体定义需要继承自 RealmObject类。</p>
<p>这里需要知道的几点：</p>
<ul>
<li><code>@PrimaryKey</code>用来标识主键</li>
<li>默认的所有的字段都会被存储</li>
<li>如果某个字段不需要被存储到本地，则需在在这个字段上面加上<code>@Ignore</code>注解</li>
</ul>
<h3 id="三-CRUD（增删改查操作）"><a href="#三-CRUD（增删改查操作）" class="headerlink" title="三.CRUD（增删改查操作）"></a>三.CRUD（增删改查操作）</h3><p>数据库的使用无非上就是增删改查这四种操作，其中查是重点，在写原生sql语句中这也是个难点。下面我们就来看看Realm的CRUD是怎样的</p>
<h4 id="1-添加数据"><a href="#1-添加数据" class="headerlink" title="1.添加数据"></a>1.添加数据</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">RealmConfiguration realmConfig = new RealmConfiguration</div><div class="line">                .Builder(this)</div><div class="line">                .build();</div><div class="line">Realm realm = Realm.getInstance(realmConfig);</div></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">public void testAdd() &#123;</div><div class="line">       initRealm();</div><div class="line">       realm.executeTransaction(new Realm.Transaction() &#123;</div><div class="line">           @Override</div><div class="line">           public void execute(Realm realm) &#123;</div><div class="line">               for (int i = 0; i <span class="tag">&lt; <span class="attr">10</span>; <span class="attr">i</span>++) &#123;</span></div><div class="line">                   <span class="attr">User</span> <span class="attr">user</span> = <span class="string">realm.createObject(User.class);</span></div><div class="line">                   <span class="attr">user.setName</span>("<span class="attr">user</span>" + <span class="attr">i</span>);</div><div class="line">                   <span class="attr">user.setAge</span>(<span class="attr">10</span> + <span class="attr">i</span>);</div><div class="line">                   <span class="attr">user.setId</span>(<span class="attr">UUID.randomUUID</span>()<span class="attr">.toString</span>());</div><div class="line">               &#125;</div><div class="line">               <span class="attr">showInTextView</span>("<span class="attr">10</span>条数据添加成功");</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>在用Realm进行操作之前需要对Realm作相关的配置操作，Realm中所有的写操作都必须在事务中进行，不然就会报错，<strong>记得在Activity的onDestory中调用realm.close()释放资源</strong>。上面的代码片段就创建了10个User对象。</p>
<h4 id="2-查询数据"><a href="#2-查询数据" class="headerlink" title="2.查询数据"></a>2.查询数据</h4><ul>
<li><p>查询全部</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public void testQuery() &#123;</div><div class="line">       List<span class="tag">&lt;<span class="name">User</span>&gt;</span> users= realm.where(User.class).findAll();</div><div class="line">       for (User user: users) &#123;</div><div class="line">           showInTextView("id:" + user.getId() + " name:" + user.getName() + " age:" + user.getAge());</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>条件查询，Realm 支持以下查询条件（来源于官网）：</p>
<ul>
<li>between()、greaterThan()、lessThan()、greaterThanOrEqualTo() 和 lessThanOrEqualTo()</li>
<li>equalTo() 和 notEqualTo()</li>
<li>contains()、beginsWith() 和 endsWith()</li>
<li>isNull() 和 isNotNull()</li>
<li>isEmpty() 和 isNotEmpty()</li>
</ul>
</li>
</ul>
<p>以下代码片段查询年龄小于15的User<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public void testQueryAgeLessThan15() &#123;</div><div class="line">       List<span class="tag">&lt;<span class="name">User</span>&gt;</span> users= realm.where(User.class).lessThan("age", 15).findAll();</div><div class="line">       for (User user: users) &#123;</div><div class="line">           showInTextView("id:" + user.getId() + " name:" + user.getName() + " age:" + user.getAge());</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>聚合查询，支持的聚合操作有sum，min，max，average<br>以下代码片段得到所有人的平均年龄<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public void testQueryAverageAge() &#123;</div><div class="line">        double age = realm.where(User.class).findAll().average("age");</div><div class="line">        textView.setText("average age:" + age);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="3-更新数据"><a href="#3-更新数据" class="headerlink" title="3.更新数据"></a>3.更新数据</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public void testUpdate() &#123;</div><div class="line">       realm.executeTransaction(new Realm.Transaction() &#123;</div><div class="line">           @Override</div><div class="line">           public void execute(Realm realm) &#123;</div><div class="line">               User user = realm.where(User.class).equalTo("name", "user9").findFirst();</div><div class="line">               if (user != null) &#123;</div><div class="line">                   user.setAge(99);</div><div class="line">                   user.setName("二逼青年");</div><div class="line">               &#125;</div><div class="line">               textView.setText("更新成功");</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h4 id="4-删除数据"><a href="#4-删除数据" class="headerlink" title="4.删除数据"></a>4.删除数据</h4><p>以下代码片段展示了如何删除指定的对象<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">public void testDelete() &#123;</div><div class="line">       realm.executeTransaction(new Realm.Transaction() &#123;</div><div class="line">           @Override</div><div class="line">           public void execute(Realm realm) &#123;</div><div class="line">               User user = realm.where(User.class).equalTo("name", "user0").findFirst();</div><div class="line">               if (user != null)</div><div class="line">                   user.deleteFromRealm();</div><div class="line">               textView.setText("删除成功");</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<h3 id="四-进阶用法"><a href="#四-进阶用法" class="headerlink" title="四.进阶用法"></a>四.进阶用法</h3><p>通过前面一节的学习，我们基本学会了Realm数据库基本的增删改查操作。<br>本节来看看Realm还有什么其他用法</p>
<h4 id="1-用json创建对象"><a href="#1-用json创建对象" class="headerlink" title="1.用json创建对象"></a>1.用json创建对象</h4><p>在实际开发中我们和json打交道的机会比较多，所以直接从json去创建对象是十分有用的，下面的代码片段展示了怎么去用。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">private void testAddFromJson() &#123;</div><div class="line">        realm.executeTransaction(new Realm.Transaction() &#123;</div><div class="line">            @Override</div><div class="line">            public void execute(Realm realm) &#123;</div><div class="line">                String json = "&#123;\n" +</div><div class="line">                        "    \"id\": \"uuid1\",\n" +</div><div class="line">                        "    \"name\": \"solid\",\n" +</div><div class="line">                        "    \"age\": 20\n" +</div><div class="line">                        "&#125;";</div><div class="line">                String jsons = "[\n" +</div><div class="line">                        "    &#123;\n" +</div><div class="line">                        "        \"id\": \"uuid1\",\n" +</div><div class="line">                        "        \"name\": \"solid\",\n" +</div><div class="line">                        "        \"age\": 20\n" +</div><div class="line">                        "    &#125;,\n" +</div><div class="line">                        "    &#123;\n" +</div><div class="line">                        "        \"id\": \"uuid2\",\n" +</div><div class="line">                        "        \"name\": \"jhack\",\n" +</div><div class="line">                        "        \"age\": 21\n" +</div><div class="line">                        "    &#125;,\n" +</div><div class="line">                        "    &#123;\n" +</div><div class="line">                        "        \"id\": \"uuid3\",\n" +</div><div class="line">                        "        \"name\": \"tom\",\n" +</div><div class="line">                        "        \"age\": 22\n" +</div><div class="line">                        "    &#125;\n" +</div><div class="line">                        "]";</div><div class="line">                //realm.createObjectFromJson(User.class, json);</div><div class="line">                realm.createAllFromJson(User.class, jsons);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<h4 id="2-数据模型改变的处理"><a href="#2-数据模型改变的处理" class="headerlink" title="2.数据模型改变的处理"></a>2.数据模型改变的处理</h4><p> 开发中数据模型不可能从一开始创建了，就保证后面的开发过程中不会更改，对于Realm如果其中的某个实体类改变了，而我们没有做任何的处理，就会报错，如果还处于应用的开发的初期，这无所谓，直接清空数据即可，但是如果应用已经发布了，我们就需要去寻找一种解决方案了。</p>
<p>这里的解决方案如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">public class MyMigration implements RealmMigration &#123;</div><div class="line">    @Override</div><div class="line">    public void migrate(DynamicRealm realm, long oldVersion, long newVersion) &#123;</div><div class="line">        Log.e(MainActivity.TAG, "oldVersion:" + oldVersion + " newVersion:" + newVersion);</div><div class="line"></div><div class="line">        RealmSchema schema = realm.getSchema();</div><div class="line"></div><div class="line">        if (newVersion == 2) &#123;</div><div class="line">            schema.get("User")</div><div class="line">                    .addField("desc", String.class);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean equals(Object obj) &#123;</div><div class="line">        return obj instanceof MyMigration;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public int hashCode() &#123;</div><div class="line">        return super.hashCode();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">realmConfig = new RealmConfiguration</div><div class="line">               .Builder(this)</div><div class="line">               .schemaVersion(2)</div><div class="line">               .migration(new MyMigration())</div><div class="line">               .build();</div></pre></td></tr></table></figure>
<h4 id="3-与RxJava的结合"><a href="#3-与RxJava的结合" class="headerlink" title="3.与RxJava的结合"></a>3.与RxJava的结合</h4><p>Realm原生是支持Rxjava的，由于RxJava 是可选依赖，所以在使用的时候需要在app的build文件中添加RxJava库的依赖，下面是使用的代码片段。<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">public void testRxJava() &#123;</div><div class="line">        realm.where(User.class).findAll()</div><div class="line">                .asObservable()</div><div class="line">                .flatMap(new Func1&lt;RealmResults&lt;User&gt;, Observable&lt;User&gt;&gt;() &#123;</div><div class="line">                    @Override</div><div class="line">                    public Observable&lt;User&gt; call(RealmResults&lt;User&gt; users) &#123;</div><div class="line">                        return Observable.from(users);</div><div class="line">                    &#125;</div><div class="line">                &#125;)</div><div class="line">                .subscribe(new Action1&lt;User&gt;() &#123;</div><div class="line">                    @Override</div><div class="line">                    public void call(User user) &#123;</div><div class="line">                        showInTextView("id:" + user.getId() + " name:" + user.getName() + " age:" + user.getAge() + " desc:" + user.getDesc());</div><div class="line"></div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>这篇文章接到这了，遗憾的是Realm在Windows中没有相关的查看器，只有Mac版的，所以不能直接在Windows中查看Realm数据库中的数据，希望官方后面会有支持吧。更多的资料请查看官方文档。<br>参考文档：<a href="https://realm.io/docs/java/latest/" target="_blank" rel="external">realm-java</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.solidev.me/2016/08/16/聊聊对RxJava与Retrofit的封装/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="_SOLID">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="_SOLID的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/16/聊聊对RxJava与Retrofit的封装/" itemprop="url">
                  聊聊对RxJava与Retrofit的封装
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-16T13:46:00+08:00">
                2016-08-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>目前RxJava和Retrofit结合使用已经是非常普遍了，网上关于这方面的文章也是层出不穷，其实大致的思想都是差不多的，今天我也来写一篇关于RxJava与Retrofit的文章，聊一聊关于RxJava与Retrofit的封装，尽可能的能让其适用于大部分项目，以供大家在学习这方面的时候多一份参考。</p>
</blockquote>
<p>关于RxJava的基础使用可以参考我的另一篇文章：<a href="http://www.jianshu.com/p/8cf84f719188" target="_blank" rel="external">是时候学习RxJava了</a>，至于Retrofit的基本使用这里我就不做介绍了，这里可以给大家提供一个学习Retrofit比较全面的网址<a href="https://futurestud.io/blog/retrofit-getting-started-and-android-client" target="_blank" rel="external">retrofit-getting-started-and-android-client</a>，对Retrofit还不太熟悉的同学可以先去看看上面的系列文章。</p>
<p>闲话不多说了，直接上今天的主题。我们先来看看关于RxJava和Retrofit最基本的使用是怎么样的</p>
<p>首先我们需要去定义一个对应接口的Service和返回结果的实体类<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public class GankResultBean &#123;</div><div class="line">    private boolean error;</div><div class="line">    private List<span class="tag">&lt;<span class="name">ResultsBean</span>&gt;</span> results;</div><div class="line">    ...省略部分代码...</div><div class="line">&#125;</div><div class="line"> public interface RxGankService &#123;</div><div class="line">        @GET("data/all/20/&#123;page&#125;")</div><div class="line">        Observable<span class="tag">&lt;<span class="name">GankResultBean</span>&gt;</span> getAndroidData(@Path("page") int page);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>接着再去初始化Retrofit<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Retrofit retrofit = new Retrofit.Builder()</div><div class="line">                .baseUrl("http://gank.io/api/")</div><div class="line">                .addConverterFactory(GsonConverterFactory.create())</div><div class="line">                .addCallAdapterFactory(RxJavaCallAdapterFactory.create())</div><div class="line">                .build();</div></pre></td></tr></table></figure></p>
<p>最后我们就可以去使用了<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">RxGankService rxGankService = retrofit.create(RxGankService.class);</div><div class="line">Observable<span class="tag">&lt;<span class="name">GankResultBean</span>&gt;</span> observable = rxGankService.getAndroidData(1);</div><div class="line">observable.subscribeOn(Schedulers.io())</div><div class="line">               .observeOn(AndroidSchedulers.mainThread())</div><div class="line">               .subscribe(new Subscriber<span class="tag">&lt;<span class="name">GankResultBean</span>&gt;</span>() &#123;</div><div class="line">                   @Override</div><div class="line">                   public void onCompleted() &#123;</div><div class="line"></div><div class="line">                   &#125;</div><div class="line"></div><div class="line">                   @Override</div><div class="line">                   public void onError(Throwable e) &#123;</div><div class="line"></div><div class="line">                   &#125;</div><div class="line"></div><div class="line">                   @Override</div><div class="line">                   public void onNext(GankResultBean gankResultBean) &#123;</div><div class="line"></div><div class="line">                   &#125;</div><div class="line">               &#125;);</div></pre></td></tr></table></figure></p>
<p>逻辑还是挺清晰的，但是呢，如果每次使用都让你去写这么多的代码肯定会觉得很乏味，并且这里我还没有对返回结果做错误处理，于是我们就应该考虑一下对代码封装一下了。</p>
<p>但是应该从哪里入手呢，这里简单分析下：</p>
<ul>
<li>看上面的代码我们会发现Retrofit初始化的那段代码，一般就一个baseUrl会有不同，其他的基本是一致的，如果我们每次去创建一个Service都要去写那么多重复的代码也大大增加了冗余度</li>
<li>对于返回的结果一般情况下数据格式是这样的：<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">   code:1,</div><div class="line">   msg:"your message",</div><div class="line">   data:[]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>code是服务器端和客户端约定好的一种规则，比如1表示数据请求成功，-1表示请求失败，-2表示权限不足等等，msg代表提示消息，其中data可能是数组对象也可能是普通的对象，我们可以考虑对返回的结果做一个统一的处理。</p>
<p>经过上面的分析我们大致有了一个方向，对于Service的创建应该有一个类去单独处理。所以这里我创建了一个ServiceFactory的类。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Created by _SOLID</div><div class="line"> * Date:2016/7/27</div><div class="line"> * Time:15:23</div><div class="line"> */</div><div class="line">public class ServiceFactory &#123;</div><div class="line"></div><div class="line">    private final Gson mGsonDateFormat;</div><div class="line"></div><div class="line">    private ServiceFactory() &#123;</div><div class="line">        mGsonDateFormat = new GsonBuilder()</div><div class="line">                .setDateFormat("yyyy-MM-dd hh:mm:ss")</div><div class="line">                .create();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static class SingletonHolder &#123;</div><div class="line">        private static final ServiceFactory INSTANCE = new ServiceFactory();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static ServiceFactory getInstance() &#123;</div><div class="line">        return SingletonHolder.INSTANCE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * create a service</div><div class="line">     *</div><div class="line">     * @param serviceClass</div><div class="line">     * @param <span class="tag">&lt;<span class="name">S</span>&gt;</span></div><div class="line">     * @return</div><div class="line">     */</div><div class="line">    public <span class="tag">&lt;<span class="name">S</span>&gt;</span> S createService(Class<span class="tag">&lt;<span class="name">S</span>&gt;</span> serviceClass) &#123;</div><div class="line">        String baseUrl = "";</div><div class="line">        try &#123;</div><div class="line">            Field field1 = serviceClass.getField("BASE_URL");</div><div class="line">            baseUrl = (String) field1.get(serviceClass);</div><div class="line">        &#125; catch (NoSuchFieldException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; catch (IllegalAccessException e) &#123;</div><div class="line">            e.getMessage();</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        Retrofit retrofit = new Retrofit.Builder()</div><div class="line">                .baseUrl(baseUrl)</div><div class="line">                .client(getOkHttpClient())</div><div class="line">                .addConverterFactory(GsonConverterFactory.create(mGsonDateFormat))</div><div class="line">                .addCallAdapterFactory(RxJavaCallAdapterFactory.create())</div><div class="line">                .build();</div><div class="line">        return retrofit.create(serviceClass);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private final static long DEFAULT_TIMEOUT = 10;</div><div class="line"></div><div class="line">    private OkHttpClient getOkHttpClient() &#123;</div><div class="line">        //定制OkHttp</div><div class="line">        OkHttpClient.Builder httpClientBuilder = new OkHttpClient.Builder();</div><div class="line">        //设置超时时间</div><div class="line">        httpClientBuilder.connectTimeout(DEFAULT_TIMEOUT, TimeUnit.SECONDS);</div><div class="line">        httpClientBuilder.writeTimeout(DEFAULT_TIMEOUT, TimeUnit.SECONDS);</div><div class="line">        httpClientBuilder.readTimeout(DEFAULT_TIMEOUT, TimeUnit.SECONDS);</div><div class="line">        //设置缓存</div><div class="line">        File httpCacheDirectory = new File(FileUtils.getCacheDir(SolidApplication.getInstance()), "OkHttpCache");</div><div class="line">        httpClientBuilder.cache(new Cache(httpCacheDirectory, 10 * 1024 * 1024));</div><div class="line">        return httpClientBuilder.build();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其他的代码我就不做说明了，这里我只对createService方法做一个简单的说明：对于baseUrl是用反射去获取我们自定义Service中的BASE_URL字段，所以在使用的时候就有了一个约定，当我们新建一个Service的时候一定要有BASE_URL字段并赋值。也就是说我们在新建的Service大致是这样的<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public interface GankService &#123;</div><div class="line"></div><div class="line">    String BASE_URL = "http://www.gank.io/api/";</div><div class="line"></div><div class="line">   @GET("data/all/20/&#123;page&#125;") Observable<span class="tag">&lt;<span class="name">GankResultBean</span>&gt;</span> getAndroidData(@Path("page") int page);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>现在我们应该怎样去使用呢<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GankService gankService = ServiceFactory.getInstance().createService(GankService.class);</div></pre></td></tr></table></figure></p>
<p>是不是一下感觉创建一个Service的代码一下简洁了很多。这里还没完，我们只是解决了Service的创建，还没有对结果去做处理。</p>
<p>我以 <em><a href="http://gank.io/api/data/Android/10/1" target="_blank" rel="external">http://gank.io/api/data/Android/10/1</a></em> 这个接口为例：<br>他返回的结果的格式是这样的：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  "error": false, </div><div class="line">  "results": []</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以这里我定义了这样的一个泛型类（T 是返回结果results的类型）<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public class HttpResult<span class="tag">&lt;<span class="name">T</span>&gt;</span> &#123;</div><div class="line">    public boolean error;</div><div class="line">    public T results;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在处理结果的时候，其实用户只关心的是T，对其他数据可以统一处理下就比如这里的error字段，有了这个我们就可以再封装一下Subscriber了。<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">public abstract class HttpResultSubscriber&lt;T&gt; extends Subscriber&lt;HttpResult&lt;T&gt;&gt; &#123;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onCompleted() &#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onError(Throwable e) &#123;</div><div class="line">        Logger.e(this,e.getMessage());</div><div class="line">        e.printStackTrace();</div><div class="line">        //在这里做全局的错误处理</div><div class="line">        if (e instanceof HttpException) &#123;</div><div class="line">            // ToastUtils.getInstance().showToast(e.getMessage());</div><div class="line">        &#125;</div><div class="line">        _onError(e);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onNext(HttpResult&lt;T&gt; t) &#123;</div><div class="line">        if (!t.error)</div><div class="line">            onSuccess(t.results);</div><div class="line">        else</div><div class="line">            _onError(new Throwable("error=" + t.error));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public abstract void onSuccess(T t);</div><div class="line"></div><div class="line">    public abstract void _onError(Throwable e);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们来看看现在怎么使用吧：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">ServiceFactory.getInstance()</div><div class="line">                .createService(GankService.class)</div><div class="line">                .getAndroidData(1)</div><div class="line">                .observeOn(AndroidSchedulers.mainThread())</div><div class="line">                .subscribeOn(Schedulers.io())</div><div class="line">                .subscribe(new HttpResultSubscriber&lt;List&lt;GanHuoDataBean&gt;&gt;() &#123;</div><div class="line">                    @Override</div><div class="line">                    public void onSuccess(List&lt;GanHuoDataBean&gt; list) &#123;</div><div class="line"></div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    @Override</div><div class="line">                    public void _onError(Throwable e) &#123;</div><div class="line"></div><div class="line">                    &#125;</div><div class="line">                &#125;);</div></pre></td></tr></table></figure></p>
<p>把这段代码与文章开始那段代码比较一下，是不是神清气爽了很多，并且这里还做了错误处理的。</p>
<p>细心的同学肯定注意到了这段代码，这段代码每次都是在重复的使用<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">observeOn(AndroidSchedulers.mainThread())</div><div class="line">.subscribeOn(Schedulers.io())</div></pre></td></tr></table></figure></p>
<p>这里我们可以创建一个TransformUtils类去处理一下<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">public class TransformUtils &#123;</div><div class="line"></div><div class="line">    public static <span class="tag">&lt;<span class="name">T</span>&gt;</span> Observable.Transformer<span class="tag">&lt;<span class="name">T,</span> <span class="attr">T</span>&gt;</span> defaultSchedulers() &#123;</div><div class="line">        return new Observable.Transformer<span class="tag">&lt;<span class="name">T,</span> <span class="attr">T</span>&gt;</span>() &#123;</div><div class="line">            @Override</div><div class="line">            public Observable<span class="tag">&lt;<span class="name">T</span>&gt;</span> call(Observable<span class="tag">&lt;<span class="name">T</span>&gt;</span> tObservable) &#123;</div><div class="line">                return tObservable.observeOn(AndroidSchedulers.mainThread()).subscribeOn(Schedulers.io());</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static <span class="tag">&lt;<span class="name">T</span>&gt;</span> Observable.Transformer<span class="tag">&lt;<span class="name">T,</span> <span class="attr">T</span>&gt;</span> all_io() &#123;</div><div class="line">        return new Observable.Transformer<span class="tag">&lt;<span class="name">T,</span> <span class="attr">T</span>&gt;</span>() &#123;</div><div class="line">            @Override</div><div class="line">            public Observable<span class="tag">&lt;<span class="name">T</span>&gt;</span> call(Observable<span class="tag">&lt;<span class="name">T</span>&gt;</span> tObservable) &#123;</div><div class="line">                return tObservable.observeOn(Schedulers.io()).subscribeOn(Schedulers.io());</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后在使用的时候使用compose操作符就可以了<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">.compose(TransformUtils.&lt;HttpResult&lt;List&lt;GanHuoDataBean&gt;&gt;&gt;defaultSchedulers())</div></pre></td></tr></table></figure></p>
<p>我们都知道对于网络请求肯定会有不成功的情况，有没有一种方案能够处理一下？其实RxJava已经为我们提供了这样的一个操作符<code>RetryWhen</code>可以用来实现重试机制，我这里有一个实现好的一个机制，默认情况下，最多重试3次，第一次会等3s，第二次会等6s，第三次会等9s。<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">public class RetryWhenNetworkException implements Func1&lt;Observable&lt;? extends Throwable&gt;, Observable&lt;?&gt;&gt; &#123;</div><div class="line">    private int count = 3;//retry count</div><div class="line">    private long delay = 3000;//delay time</div><div class="line"></div><div class="line">    public RetryWhenNetworkException() &#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public RetryWhenNetworkException(int count) &#123;</div><div class="line">        this.count = count;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public RetryWhenNetworkException(int count, long delay) &#123;</div><div class="line">        this.count = count;</div><div class="line">        this.delay = delay;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public Observable&lt;?&gt; call(Observable&lt;? extends Throwable&gt; observable) &#123;</div><div class="line">        return observable</div><div class="line">                .zipWith(Observable.range(1, count + 1), new Func2&lt;Throwable, Integer, Wrapper&gt;() &#123;</div><div class="line">                    @Override</div><div class="line">                    public Wrapper call(Throwable throwable, Integer integer) &#123;</div><div class="line">                        return new Wrapper(throwable, integer);</div><div class="line">                    &#125;</div><div class="line">                &#125;).flatMap(new Func1&lt;Wrapper, Observable&lt;?&gt;&gt;() &#123;</div><div class="line">                    @Override</div><div class="line">                    public Observable&lt;?&gt; call(Wrapper wrapper) &#123;</div><div class="line">                        if ((wrapper.throwable instanceof ConnectException</div><div class="line">                                || wrapper.throwable instanceof SocketTimeoutException</div><div class="line">                                || wrapper.throwable instanceof TimeoutException)</div><div class="line">                                &amp;&amp; wrapper.index &lt; count + 1) &#123;</div><div class="line">                            return Observable.timer(delay + (wrapper.index - 1) * delay, TimeUnit.MILLISECONDS);</div><div class="line">                        &#125;</div><div class="line">                        return Observable.error(wrapper.throwable);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private class Wrapper &#123;</div><div class="line">        private int index;</div><div class="line">        private Throwable throwable;</div><div class="line"></div><div class="line">        public Wrapper(Throwable throwable, int index) &#123;</div><div class="line">            this.index = index;</div><div class="line">            this.throwable = throwable;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<p>到这里对于RxJava与Retrofit的封装的基本封装就差不多了，也能适用于大部分的项目中去了，一般情况下改改HttpResult和HttpResultSubscriber这两个类就可以了。<br>但是实际开发中有可能会遇到这样的一种情况：直接去访问一个完整的Url，还有用Retrofit去做下载该怎么做呢？</p>
<p>其实解决方案是有的，这里我们可以去定义一个CommonService<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">public interface CommonService &#123;</div><div class="line">    String BASE_URL = "http://www.example.com/";//这个不重要，可以随便写，但是必须有</div><div class="line"></div><div class="line">    @GET</div><div class="line">    Observable<span class="tag">&lt;<span class="name">ResponseBody</span>&gt;</span> loadString(@Url String url);</div><div class="line"></div><div class="line">    @GET</div><div class="line">    @Streaming</div><div class="line">    Observable<span class="tag">&lt;<span class="name">ResponseBody</span>&gt;</span> download(@Url String url);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其实就是把参数的注解换成@Url就可以了，关于实现的细节可以参考文末给出的源码。</p>
<p>本文源码地址:<a href="https://github.com/burgessjp/GanHuoIO/tree/v3.1.0/library/src/main/java/ren/solid/library/rx/retrofit" target="_blank" rel="external">源码</a></p>
<p>参考资料可以去我管理的专题查看：<br><a href="http://www.jianshu.com/collection/d79a6385bded" target="_blank" rel="external">RxJava系列专题（Android方向）</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="_SOLID" />
          <p class="site-author-name" itemprop="name">_SOLID</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">19</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">_SOLID</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  

  

  

  

</body>
</html>
